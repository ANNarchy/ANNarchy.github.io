
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../_static/logo.svg">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.4">
    
    
      
        <title>Convolution and Pooling - ANNarchy 4.7.1</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.bb3983ee.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#convolution-and-pooling" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="ANNarchy 4.7.1" class="md-header__button md-logo" aria-label="ANNarchy 4.7.1" data-md-component="logo">
      
  <img src="../../_static/logowhite.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ANNarchy 4.7.1
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Convolution and Pooling
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ANNarchy/ANNarchy/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="ANNarchy 4.7.1" class="md-nav__button md-logo" aria-label="ANNarchy 4.7.1" data-md-component="logo">
      
  <img src="../../_static/logowhite.svg" alt="logo">

    </a>
    ANNarchy 4.7.1
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ANNarchy/ANNarchy/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Manual
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Manual" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Manual
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/Structure/" class="md-nav__link">
        General structure
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/Parser/" class="md-nav__link">
        Parser
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/RateNeuron/" class="md-nav__link">
        Rate-coded neurons
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/SpikeNeuron/" class="md-nav__link">
        Spiking neurons
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/RateSynapse/" class="md-nav__link">
        Rate-coded synapses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/SpikeSynapse/" class="md-nav__link">
        Spiking synapses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/Populations/" class="md-nav__link">
        Populations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/Projections/" class="md-nav__link">
        Projections
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/Connector/" class="md-nav__link">
        Connectivity
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/Inputs/" class="md-nav__link">
        Setting inputs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/Simulation/" class="md-nav__link">
        Simulation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/Configuration/" class="md-nav__link">
        Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/NumericalMethods/" class="md-nav__link">
        Equations and numerical methods
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/Recording/" class="md-nav__link">
        Recording with Monitors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/Saving/" class="md-nav__link">
        Saving and loading a network
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/Network/" class="md-nav__link">
        Parallel simulations and networks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/Hybrid/" class="md-nav__link">
        Hybrid networks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/StructuralPlasticity/" class="md-nav__link">
        Structural plasticity
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/ConvolutionalNetworks/" class="md-nav__link">
        Convolution and pooling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/Notebooks/" class="md-nav__link">
        Notebooks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/Reporting/" class="md-nav__link">
        Reporting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/Logging/" class="md-nav__link">
        Logging with tensorboard
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1">
          core
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="core" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          core
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ANNarchy/" class="md-nav__link">
        Top-level methods
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Neuron/" class="md-nav__link">
        Neuron class
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../SpecificNeuron/" class="md-nav__link">
        Built-in neuron types
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Synapse/" class="md-nav__link">
        Synapse class
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../SpecificSynapse/" class="md-nav__link">
        Built-in synapse types
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Population/" class="md-nav__link">
        Population class
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../SpecificPopulation/" class="md-nav__link">
        Specific Populations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Projection/" class="md-nav__link">
        Projection class
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../SpecificProjection/" class="md-nav__link">
        Specific Projections
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Dendrite/" class="md-nav__link">
        Dendrite class
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Monitor/" class="md-nav__link">
        Monitoring
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../RandomDistribution/" class="md-nav__link">
        Random Distributions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Network/" class="md-nav__link">
        Network class
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../IO/" class="md-nav__link">
        Saving / Loading
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Utilities/" class="md-nav__link">
        Reporting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Hybrid/" class="md-nav__link">
        Hybrid networks
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2">
          extensions
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="extensions" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          extensions
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Convolution and Pooling
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Convolution and Pooling
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Convolve.Convolution" class="md-nav__link">
    Convolution
  </a>
  
    <nav class="md-nav" aria-label="Convolution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Convolve.Convolution.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Convolve.Convolution.connect_filter" class="md-nav__link">
    connect_filter()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Convolve.Convolution.connect_filters" class="md-nav__link">
    connect_filters()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Convolve.Convolution.connectivity_matrix" class="md-nav__link">
    connectivity_matrix()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Convolve.Convolution.load" class="md-nav__link">
    load()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Convolve.Convolution.receptive_fields" class="md-nav__link">
    receptive_fields()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Convolve.Convolution.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Convolve.Convolution.save_connectivity" class="md-nav__link">
    save_connectivity()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Pooling" class="md-nav__link">
    Pooling
  </a>
  
    <nav class="md-nav" aria-label="Pooling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Pooling.Pooling" class="md-nav__link">
    Pooling
  </a>
  
    <nav class="md-nav" aria-label="Pooling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Pooling.Pooling.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Pooling.Pooling.connect_pooling" class="md-nav__link">
    connect_pooling()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Pooling.Pooling.connectivity_matrix" class="md-nav__link">
    connectivity_matrix()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Pooling.Pooling.load" class="md-nav__link">
    load()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Pooling.Pooling.receptive_fields" class="md-nav__link">
    receptive_fields()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Pooling.Pooling.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Pooling.Pooling.save_connectivity" class="md-nav__link">
    save_connectivity()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy" class="md-nav__link">
    Copy
  </a>
  
    <nav class="md-nav" aria-label="Copy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy.Copy" class="md-nav__link">
    Copy
  </a>
  
    <nav class="md-nav" aria-label="Copy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy.Copy.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy.Copy.connect_copy" class="md-nav__link">
    connect_copy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy.Copy.connectivity_matrix" class="md-nav__link">
    connectivity_matrix()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy.Copy.generate_omp" class="md-nav__link">
    generate_omp()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy.Copy.load" class="md-nav__link">
    load()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy.Copy.receptive_fields" class="md-nav__link">
    receptive_fields()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy.Copy.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy.Copy.save_connectivity" class="md-nav__link">
    save_connectivity()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Logging/" class="md-nav__link">
        Logging with tensorboard
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../BOLD/" class="md-nav__link">
        BOLD monitoring
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Examples
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Examples" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Examples
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example/List/" class="md-nav__link">
        List of notebooks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example/NeuralField/" class="md-nav__link">
        Neural Field
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example/BarLearning/" class="md-nav__link">
        Bar Learning
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example/StructuralPlasticity/" class="md-nav__link">
        Structural plasticity
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example/Izhikevich/" class="md-nav__link">
        Izhikevich
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example/GapJunctions/" class="md-nav__link">
        Gap junctions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example/HodgkinHuxley/" class="md-nav__link">
        Hodgkin-Huxley
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example/COBA/" class="md-nav__link">
        COBA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example/STP/" class="md-nav__link">
        STP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example/SimpleSTDP/" class="md-nav__link">
        STDP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example/Ramp/" class="md-nav__link">
        Ramp
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example/Hybrid/" class="md-nav__link">
        Hybrid
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example/Image/" class="md-nav__link">
        Image
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example/Webcam/" class="md-nav__link">
        Webcam
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example/MultipleNetworks/" class="md-nav__link">
        Parallel simulations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example/BayesianOptimization/" class="md-nav__link">
        Bayesian optimization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example/BasalGanglia/" class="md-nav__link">
        Logging with tensorboard
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example/BoldMonitoring/" class="md-nav__link">
        BOLD monitoring
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../License/" class="md-nav__link">
        License
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Convolve.Convolution" class="md-nav__link">
    Convolution
  </a>
  
    <nav class="md-nav" aria-label="Convolution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Convolve.Convolution.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Convolve.Convolution.connect_filter" class="md-nav__link">
    connect_filter()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Convolve.Convolution.connect_filters" class="md-nav__link">
    connect_filters()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Convolve.Convolution.connectivity_matrix" class="md-nav__link">
    connectivity_matrix()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Convolve.Convolution.load" class="md-nav__link">
    load()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Convolve.Convolution.receptive_fields" class="md-nav__link">
    receptive_fields()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Convolve.Convolution.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Convolve.Convolution.save_connectivity" class="md-nav__link">
    save_connectivity()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Pooling" class="md-nav__link">
    Pooling
  </a>
  
    <nav class="md-nav" aria-label="Pooling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Pooling.Pooling" class="md-nav__link">
    Pooling
  </a>
  
    <nav class="md-nav" aria-label="Pooling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Pooling.Pooling.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Pooling.Pooling.connect_pooling" class="md-nav__link">
    connect_pooling()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Pooling.Pooling.connectivity_matrix" class="md-nav__link">
    connectivity_matrix()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Pooling.Pooling.load" class="md-nav__link">
    load()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Pooling.Pooling.receptive_fields" class="md-nav__link">
    receptive_fields()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Pooling.Pooling.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Pooling.Pooling.save_connectivity" class="md-nav__link">
    save_connectivity()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy" class="md-nav__link">
    Copy
  </a>
  
    <nav class="md-nav" aria-label="Copy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy.Copy" class="md-nav__link">
    Copy
  </a>
  
    <nav class="md-nav" aria-label="Copy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy.Copy.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy.Copy.connect_copy" class="md-nav__link">
    connect_copy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy.Copy.connectivity_matrix" class="md-nav__link">
    connectivity_matrix()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy.Copy.generate_omp" class="md-nav__link">
    generate_omp()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy.Copy.load" class="md-nav__link">
    load()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy.Copy.receptive_fields" class="md-nav__link">
    receptive_fields()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy.Copy.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ANNarchy.extensions.convolution.Copy.Copy.save_connectivity" class="md-nav__link">
    save_connectivity()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/ANNarchy/ANNarchy/edit/master/docs/API/Convolution.md" title="Edit this page" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>


<h1 id="convolution-and-pooling">Convolution and Pooling<a class="headerlink" href="#convolution-and-pooling" title="Permanent link">#</a></h1>
<p>Convolution and pooling operations are provided in the module
<code>ANNarchy.extensions.convolution</code>. They must be explicitely imported:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">ANNarchy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ANNarchy.extensions.convolution</span> <span class="kn">import</span> <span class="o">*</span>
</code></pre></div>


  <div class="doc doc-object doc-class">



<h2 id="ANNarchy.extensions.convolution.Convolve.Convolution" class="doc doc-heading">
        <code>
ANNarchy.extensions.convolution.Convolve.Convolution            (<a title="ANNarchy.core.Projection.Projection" href="../Projection/#ANNarchy.core.Projection.Projection">Projection</a>)
        </code>



<a href="#ANNarchy.extensions.convolution.Convolve.Convolution" class="headerlink" title="Permanent link">#</a></h2>

    <div class="doc doc-contents first">

      <p>Performs a convolution of a weight kernel on the pre-synaptic population.</p>
<p>Despite its name, the operation performed is actually a cross-correlation, as is usual in computer vision and convolutional neural networks:</p>
<div class="arithmatex">\[g(x) = \sum_{k=-n}^n h(k) \, f(x + k)\]</div>
<p>The convolution operation benefits from giving a multi-dimensional geometry to the populations and filters, for example in 2D:</p>
<div class="highlight"><pre><span></span><code><span class="n">inp</span> <span class="o">=</span> <span class="n">Population</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">neuron</span><span class="o">=</span><span class="n">Neuron</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="s2">&quot;r = 0.0&quot;</span><span class="p">))</span>
<span class="n">pop</span> <span class="o">=</span> <span class="n">Population</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">neuron</span><span class="o">=</span><span class="n">Neuron</span><span class="p">(</span><span class="n">equations</span><span class="o">=</span><span class="s2">&quot;r = sum(exc)&quot;</span><span class="p">))</span>
<span class="n">proj</span> <span class="o">=</span> <span class="n">Convolution</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">pop</span><span class="p">,</span> <span class="s1">&#39;exc&#39;</span><span class="p">)</span>
<span class="n">proj</span><span class="o">.</span><span class="n">connect_filter</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]</span>
    <span class="p">])</span>
</code></pre></div>
<p>The maximum number of dimensions for populations and filters is 4, an error is thrown otherwise.</p>
<p>Depending on the number of dimensions of the pre- and post-synaptic populations, as well as of the kernel, the convolution is implemented differentely.</p>
<p><strong>Method connect_filter()</strong></p>
<ul>
<li>
<p>If the pre- and post-populations have the same dimension as the kernel, the convolution is regular. Example:</p>
<p>(100, 100) * (3, 3) -&gt; (100, 100)</p>
</li>
<li>
<p>If the post-population has one dimension less than the pre-synaptic one, the last dimension of the kernel must match the last one of the pre-synaptic population. Example:</p>
<p>(100, 100, 3) * (3, 3, 3) -&gt; (100, 100)</p>
</li>
<li>
<p>If the kernel has less dimensions than the two populations, the number of neurons in the last dimension of the populations must be the same. The convolution will be calculated for each feature map in the last dimension. In this case, you must set <code>keep_last_dimension</code> to <code>True</code>. Example:</p>
<p>(100, 100, 16) * (3, 3) -&gt; (100, 100, 16)</p>
</li>
</ul>
<p><strong>Method connect_filters()</strong></p>
<ul>
<li>
<p>If the kernel has more dimensions than the pre-synaptic population, this means a bank of different filters will be applied on the pre-synaptic population (like a convolutional layer in a CNN). Attention: the first index of <code>weights</code> corresponds to the different filters, while the result will be accessible in the last dimension of the post-synaptic population. You must set the <code>multiple</code> argument to True. Example:</p>
<p>(100, 100) * (16, 3, 3) -&gt; (100, 100, 16)</p>
</li>
</ul>
<p>The convolution <strong>always</strong> uses padding for elements that would be outside the array (no equivalent of <code>valid</code> in tensorflow). It is 0.0 by default, but can be changed using the <code>padding</code> argument. Setting <code>padding</code> to the string <code>border</code> will repeat the value of the border elements.</p>
<p>Sub-sampling will be automatically performed according to the populations' geometry. If these geometries do not match, an error will be thrown. Example:</p>
<div class="highlight"><pre><span></span><code>(100, 100) * (3, 3) -&gt; (50, 50)
</code></pre></div>
<p>You can redefine the sub-sampling by providing a list <code>subsampling</code> as argument, defining for each post-synaptic neuron the coordinates of the pre-synaptic neuron which will be the center of the filter/kernel.</p>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Convolve.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Convolution</span><span class="p">(</span><span class="n">Projection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs a convolution of a weight kernel on the pre-synaptic population.</span>

<span class="sd">    Despite its name, the operation performed is actually a cross-correlation, as is usual in computer vision and convolutional neural networks:</span>

<span class="sd">    $$g(x) = \sum_{k=-n}^n h(k) \, f(x + k)$$</span>

<span class="sd">    The convolution operation benefits from giving a multi-dimensional geometry to the populations and filters, for example in 2D:</span>

<span class="sd">    ```python</span>
<span class="sd">    inp = Population(geometry=(100, 100), neuron=Neuron(parameters=&quot;r = 0.0&quot;))</span>
<span class="sd">    pop = Population(geometry=(100, 100), neuron=Neuron(equations=&quot;r = sum(exc)&quot;))</span>
<span class="sd">    proj = Convolution(inp, pop, &#39;exc&#39;)</span>
<span class="sd">    proj.connect_filter(</span>
<span class="sd">        [</span>
<span class="sd">            [-1., 0., 1.],</span>
<span class="sd">            [-1., 0., 1.],</span>
<span class="sd">            [-1., 0., 1.]</span>
<span class="sd">        ])</span>
<span class="sd">    ```</span>

<span class="sd">    The maximum number of dimensions for populations and filters is 4, an error is thrown otherwise.</span>

<span class="sd">    Depending on the number of dimensions of the pre- and post-synaptic populations, as well as of the kernel, the convolution is implemented differentely.</span>

<span class="sd">    **Method connect_filter()**</span>

<span class="sd">    * If the pre- and post-populations have the same dimension as the kernel, the convolution is regular. Example:</span>

<span class="sd">        (100, 100) * (3, 3) -&gt; (100, 100)</span>

<span class="sd">    * If the post-population has one dimension less than the pre-synaptic one, the last dimension of the kernel must match the last one of the pre-synaptic population. Example:</span>

<span class="sd">        (100, 100, 3) * (3, 3, 3) -&gt; (100, 100)</span>

<span class="sd">    * If the kernel has less dimensions than the two populations, the number of neurons in the last dimension of the populations must be the same. The convolution will be calculated for each feature map in the last dimension. In this case, you must set ``keep_last_dimension`` to ``True``. Example:</span>

<span class="sd">        (100, 100, 16) * (3, 3) -&gt; (100, 100, 16)</span>

<span class="sd">    **Method connect_filters()**</span>

<span class="sd">    * If the kernel has more dimensions than the pre-synaptic population, this means a bank of different filters will be applied on the pre-synaptic population (like a convolutional layer in a CNN). Attention: the first index of ``weights`` corresponds to the different filters, while the result will be accessible in the last dimension of the post-synaptic population. You must set the ``multiple`` argument to True. Example:</span>

<span class="sd">        (100, 100) * (16, 3, 3) -&gt; (100, 100, 16)</span>

<span class="sd">    The convolution **always** uses padding for elements that would be outside the array (no equivalent of ``valid`` in tensorflow). It is 0.0 by default, but can be changed using the ``padding`` argument. Setting ``padding`` to the string ``border`` will repeat the value of the border elements.</span>

<span class="sd">    Sub-sampling will be automatically performed according to the populations&#39; geometry. If these geometries do not match, an error will be thrown. Example:</span>

<span class="sd">        (100, 100) * (3, 3) -&gt; (50, 50)</span>

<span class="sd">    You can redefine the sub-sampling by providing a list ``subsampling`` as argument, defining for each post-synaptic neuron the coordinates of the pre-synaptic neuron which will be the center of the filter/kernel.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">psp</span><span class="o">=</span><span class="s2">&quot;pre.r * w&quot;</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copied</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param pre: pre-synaptic population (either its name or a ``Population`` object).</span>
<span class="sd">        :param post: post-synaptic population (either its name or a ``Population`` object).</span>
<span class="sd">        :param target: type of the connection</span>
<span class="sd">        :param psp: continuous influence of a single synapse on the post-synaptic neuron (default for rate-coded: ``w*pre.r``).</span>
<span class="sd">        :param operation: operation (sum, max, min, mean) performed by the kernel (default: sum).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create the description, but it will not be used for generation</span>
        <span class="n">Projection</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">pre</span><span class="p">,</span>
            <span class="n">post</span><span class="p">,</span>
            <span class="n">target</span><span class="p">,</span>
            <span class="n">synapse</span><span class="o">=</span><span class="n">SharedSynapse</span><span class="p">(</span><span class="n">psp</span><span class="o">=</span><span class="n">psp</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Convolution operation&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Convoluted kernel over the pre-synaptic population.&quot;</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">copied</span><span class="o">=</span><span class="n">copied</span>
        <span class="p">)</span>

        <span class="c1"># Disable saving</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saveable</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># For copy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_used_single_filter</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_used_bank_of_filters</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">operation</span>

    <span class="k">def</span> <span class="nf">connect_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">delays</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">keep_last_dimension</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">subsampling</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies a single filter on the pre-synaptic population.</span>

<span class="sd">        :param weights: numpy array or list of lists representing the matrix of weights for the filter.</span>
<span class="sd">        :param delays: delay in synaptic transmission (default: dt). Can only be the same value for all neurons.</span>
<span class="sd">        :param keep_last_dimension: defines if the last dimension of the pre- and post-synaptic will be convolved in parallel. The weights matrix must have one dimension less than the pre-synaptic population, and the number of neurons in the last dimension of the pre- and post-synaptic populations must match. Default: False.</span>
<span class="sd">        :param padding: value to be used for the rates outside the pre-synaptic population. If it is a floating value, the pre-synaptic population is virtually extended with this value above its boundaries. If it is equal to &#39;border&#39;, the values on the boundaries are repeated. Default: 0.0.</span>
<span class="sd">        :param subsampling: list for each post-synaptic neuron of coordinates in the pre-synaptic population defining the center of the kernel/filter. Default: None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Process the weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

        <span class="c1"># Process the delays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delays</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">delays</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">delays</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolutions can only have constant delays.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">subsampling</span> <span class="o">=</span> <span class="n">subsampling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_last_dimension</span> <span class="o">=</span> <span class="n">keep_last_dimension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">padding</span> <span class="o">=</span> <span class="n">padding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Check dimensions of populations and weight matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">ndim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">dimension</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: Too many dimensions for the post-synaptic population (maximum 4).&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: Too many dimensions for the pre-synaptic population (maximum 4).&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">&gt;</span> <span class="mi">5</span>  <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: Too many dimensions for the kernel (maximum 4).&#39;</span><span class="p">)</span>

        <span class="c1"># Check if the last axes match for parallel convolution (e.g. 3-2-3)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_last_dimension</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
                <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: If the kernel has less dimensions than the pre-synaptic population, you need to set the flag keep_last_dimension to True.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
                <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: If the kernel has fewer dimensions than the two populations (keep_last_dimension=True), these must have the same number of neurons in the last dimension.&#39;</span><span class="p">)</span>

        <span class="c1"># If the last dim of the kernel matches the last dim of the pre-pop, the last pop can have one dimension less.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">:</span> <span class="c1"># OK, but check the last dimension of the kernel has the same size as the post-population</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
                <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: If the post-synaptic population has less dimensions than the pre-synaptic one, the last dimension of the filter must be equal to the last of the pre-synaptic population.&#39;</span><span class="p">)</span>

        <span class="c1"># Check if it is a bank of filters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: If the kernel has more dimensions than the pre-synaptic population, you need to use the connect_filters() method.&#39;</span><span class="p">)</span>


        <span class="c1"># Generate the pre-synaptic coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_pre_coordinates</span><span class="p">()</span>

        <span class="c1"># Finish building the synapses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">()</span>

        <span class="c1"># For copy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_used_single_filter</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="bp">self</span>


    <span class="k">def</span> <span class="nf">connect_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">delays</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">keep_last_dimension</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">subsampling</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies a set of different filters on the pre-synaptic population.</span>

<span class="sd">        The weights matrix must have one dimension more than the pre-synaptic populations, and the number of neurons in the last dimension of the post-synaptic population must be equal to the number of filters.</span>


<span class="sd">        :param weights: numpy array or list of lists representing the matrix of weights for the filter.</span>
<span class="sd">        :param delays: delay in synaptic transmission (default: dt). Can only be the same value for all neurons.</span>
<span class="sd">        :param keep_last_dimension: defines if the last dimension of the pre- and post-synaptic will be convolved in parallel. The weights matrix must have one dimension less than the pre-synaptic population, and the number of neurons in the last dimension of the pre- and post-synaptic populations must match. Default: False.</span>
<span class="sd">        :param padding: value to be used for the rates outside the pre-synaptic population. If it is a floating value, the pre-synaptic population is virtually extended with this value above its boundaries. If it is equal to &#39;border&#39;, the values on the boundaries are repeated. Default: 0.0.</span>
<span class="sd">        :param subsampling: list for each post-synaptic neuron of coordinates in the pre-synaptic population defining the center of the kernel/filter. Default: None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Process the weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

        <span class="c1"># Process the delays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delays</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">delays</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">delays</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolutions can only have constant delays.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">subsampling</span> <span class="o">=</span> <span class="n">subsampling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_last_dimension</span> <span class="o">=</span> <span class="n">keep_last_dimension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">padding</span> <span class="o">=</span> <span class="n">padding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Check dimensions of populations and weight matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">ndim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">dimension</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: Too many dimensions for the post-synaptic population (maximum 4).&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: Too many dimensions for the pre-synaptic population (maximum 4).&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">&gt;</span> <span class="mi">5</span>  <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: Too many dimensions for the kernel (maximum 4).&#39;</span><span class="p">)</span>

        <span class="c1"># Check if the last axes match for parallel convolution (e.g. 3-2-3)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_last_dimension</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
                <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: If the kernel has less dimensions than the pre-synaptic population, you need to set the flag keep_last_dimension to True.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
                <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: If the kernel has fewer dimensions than the two populations (keep_last_dimension=True), these must have the same number of neurons in the last dimension.&#39;</span><span class="p">)</span>

        <span class="c1"># If the last dim of the kernel matches the last dim of the pre-pop, the last pop can have one dimension less.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">:</span> <span class="c1"># OK, but check the last dimension of the kernel has the same size as the post-population</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
                <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: If the post-synaptic population has less dimensions than the pre-synaptic one, the last dimension of the filter must be equal to the last of the pre-synaptic population.&#39;</span><span class="p">)</span>

        <span class="c1"># The last dimension of the post population must correspond to the number of filters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: For multiple filters, the last dimension of the post-synaptic population must have as many neurons as there are filters.&#39;</span><span class="p">)</span>

        <span class="c1"># Generate the pre-synaptic coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_pre_coordinates_bank</span><span class="p">()</span>

        <span class="c1"># Finish building the synapses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">()</span>

        <span class="c1"># For copy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_used_bank_of_filters</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">):</span>
        <span class="s2">&quot;Returns a copy of the projection when creating networks.  Internal use only.&quot;</span>
        <span class="n">copied_proj</span> <span class="o">=</span> <span class="n">Convolution</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="n">post</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">copied</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">copied_proj</span><span class="o">.</span><span class="n">delays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span>
        <span class="n">copied_proj</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span>

        <span class="n">copied_proj</span><span class="o">.</span><span class="n">subsampling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsampling</span>
        <span class="n">copied_proj</span><span class="o">.</span><span class="n">keep_last_dimension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_last_dimension</span>
        <span class="n">copied_proj</span><span class="o">.</span><span class="n">padding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">padding</span>
        <span class="n">copied_proj</span><span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple</span>
        <span class="n">copied_proj</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">ndim</span>
        <span class="n">copied_proj</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span>
        <span class="n">copied_proj</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">dimension</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_used_single_filter</span><span class="p">:</span>
            <span class="n">copied_proj</span><span class="o">.</span><span class="n">_generate_pre_coordinates</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_used_bank_of_filters</span><span class="p">:</span>
            <span class="n">copied_proj</span><span class="o">.</span><span class="n">_generate_pre_coordinates_bank</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either use single filter or bank of filter must be True! (Missing connect?)&quot;</span><span class="p">)</span>

        <span class="n">copied_proj</span><span class="o">.</span><span class="n">_create</span><span class="p">()</span>
        <span class="n">copied_proj</span><span class="o">.</span><span class="n">_connection_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_method</span>
        <span class="n">copied_proj</span><span class="o">.</span><span class="n">_connection_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_args</span>
        <span class="n">copied_proj</span><span class="o">.</span><span class="n">_connection_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_delay</span>
        <span class="n">copied_proj</span><span class="o">.</span><span class="n">_storage_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage_format</span>
        <span class="k">return</span> <span class="n">copied_proj</span>

    <span class="k">def</span> <span class="nf">_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># create fake LIL object, just for compilation.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">ANNarchy.core.cython_ext.Connector</span> <span class="kn">import</span> <span class="n">LILConnectivity</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;ANNarchy was not successfully installed.&#39;</span><span class="p">)</span>

        <span class="n">lil</span> <span class="o">=</span> <span class="n">LILConnectivity</span><span class="p">()</span>
        <span class="n">lil</span><span class="o">.</span><span class="n">max_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span>
        <span class="n">lil</span><span class="o">.</span><span class="n">uniform_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connector_name</span> <span class="o">=</span> <span class="s2">&quot;Convolution&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connector_description</span> <span class="o">=</span> <span class="s2">&quot;Convolution&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_from_lil</span><span class="p">,</span> <span class="p">(</span><span class="n">lil</span><span class="p">,</span> <span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span><span class="p">)</span>

    <span class="c1">################################</span>
    <span class="c1">### Create connection pattern</span>
    <span class="c1">################################</span>
    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds up dendrites either from list or dictionary. Called by instantiate().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_method</span><span class="p">:</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: The projection between &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; and &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; is declared but not connected.&#39;</span><span class="p">)</span>

        <span class="c1"># Create the Cython instance</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;proj&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_wrapper&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cyInstance</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_coordinates</span><span class="p">)</span>

        <span class="c1"># Set delays after instantiation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cyInstance</span><span class="o">.</span><span class="n">set_delay</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delays</span><span class="o">/</span><span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_generate_pre_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot; Returns a list for each post neuron of the corresponding center coordinates.&quot;</span>

        <span class="c1"># Check if the list is already defined:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsampling</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subsampling</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: The sub-sampling list must have&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s1">&#39;elements of size&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span><span class="p">):</span>
                <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: The sub-sampling list must have&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s1">&#39;elements of size&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsampling</span>
            <span class="k">return</span>

        <span class="c1"># Otherwise create it, possibly with sub-sampling</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>

        <span class="c1"># Compute pre-indices</span>
        <span class="n">idx_range</span><span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dim</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">:</span>
                <span class="n">pre_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span>
                <span class="n">post_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span>
                <span class="n">sample</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pre_size</span><span class="o">/</span><span class="n">post_size</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">post_size</span> <span class="o">*</span> <span class="n">sample</span> <span class="o">!=</span> <span class="n">pre_size</span><span class="p">:</span>
                    <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: The pre-synaptic dimensions must be a multiple of the post-synaptic ones for down-sampling to work.&#39;</span><span class="p">)</span>

                <span class="n">idx_range</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">((</span><span class="n">sample</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">sample</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">post_size</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># extra dimension</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_last_dimension</span><span class="p">:</span>
                    <span class="n">idx_range</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">idx_range</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_center_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span><span class="p">])])</span>

        <span class="c1"># Generates coordinates TODO: Find a more robust way!</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
            <span class="n">rk</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">coords</span><span class="p">[</span><span class="n">rk</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">rk</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
            <span class="n">rk</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">coords</span><span class="p">[</span><span class="n">rk</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="n">rk</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">:</span>
            <span class="n">rk</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">coords</span><span class="p">[</span><span class="n">rk</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
                        <span class="n">rk</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">==</span> <span class="mi">4</span> <span class="p">:</span>
            <span class="n">rk</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                            <span class="n">coords</span><span class="p">[</span><span class="n">rk</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
                            <span class="n">rk</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Save the result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_coordinates</span> <span class="o">=</span> <span class="n">coords</span>

    <span class="k">def</span> <span class="nf">_generate_pre_coordinates_bank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot; Returns a list for each post neuron of the corresponding center coordinates, when the filter is a bank.&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nb_filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim_single_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># Check if the list is already defined:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsampling</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subsampling</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: The sub-sampling list must have&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;elements of size&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span><span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span><span class="p">):</span>
                <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: The sub-sampling list must have&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span><span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;elements of size&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsampling</span>  <span class="k">for</span> <span class="n">d</span>  <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_filters</span><span class="p">)]</span>
            <span class="k">return</span>

        <span class="c1"># Otherwise create it, possibly with sub-sampling</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>

        <span class="c1"># Compute pre-indices</span>
        <span class="n">idx_range</span><span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dim</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">pre_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
                <span class="n">post_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
                <span class="n">sample</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pre_size</span><span class="o">/</span><span class="n">post_size</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">post_size</span> <span class="o">*</span> <span class="n">sample</span> <span class="o">!=</span> <span class="n">pre_size</span><span class="p">:</span>
                    <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: The pre-synaptic dimensions must be a multiple of the post-synaptic ones for down-sampling to work.&#39;</span><span class="p">)</span>

                <span class="n">idx_range</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">((</span><span class="n">sample</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">sample</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">post_size</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># extra dimension</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_last_dimension</span><span class="p">:</span>
                    <span class="n">idx_range</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">idx_range</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_center_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">])])</span>


        <span class="c1"># Generates coordinates TODO: Find a more robust way!</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
            <span class="n">rk</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_filters</span><span class="p">):</span>
                    <span class="n">coords</span><span class="p">[</span><span class="n">rk</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">d</span><span class="p">]</span>
                    <span class="n">rk</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
            <span class="n">rk</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_filters</span><span class="p">):</span>
                        <span class="n">coords</span><span class="p">[</span><span class="n">rk</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">d</span> <span class="p">]</span>
                        <span class="n">rk</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">:</span>
            <span class="n">rk</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_filters</span><span class="p">):</span>
                            <span class="n">coords</span><span class="p">[</span><span class="n">rk</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">d</span><span class="p">]</span>
                            <span class="n">rk</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">==</span> <span class="mi">4</span> <span class="p">:</span>
            <span class="n">rk</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">idx_range</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_filters</span><span class="p">):</span>
                                <span class="n">coords</span><span class="p">[</span><span class="n">rk</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">d</span><span class="p">]</span>
                                <span class="n">rk</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Save the result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_coordinates</span> <span class="o">=</span> <span class="n">coords</span>

    <span class="c1">################################</span>
    <span class="c1"># Code generation</span>
    <span class="c1">################################</span>
    <span class="k">def</span> <span class="nf">_generate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overrides default code generation. This function is called during the code generation procedure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Filter definition</span>
        <span class="n">filter_definition</span><span class="p">,</span> <span class="n">filter_pyx_definition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_definition</span><span class="p">()</span>

        <span class="c1"># Convolve_code</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple</span><span class="p">:</span>
            <span class="n">convolve_code</span><span class="p">,</span> <span class="n">sum_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_convolve_code</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">convolve_code</span><span class="p">,</span> <span class="n">sum_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_bank_code</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">Global</span><span class="o">.</span><span class="n">_check_paradigm</span><span class="p">(</span><span class="s2">&quot;openmp&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_omp</span><span class="p">(</span><span class="n">filter_definition</span><span class="p">,</span> <span class="n">filter_pyx_definition</span><span class="p">,</span> <span class="n">convolve_code</span><span class="p">,</span> <span class="n">sum_code</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">Global</span><span class="o">.</span><span class="n">_check_paradigm</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_generate_omp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_definition</span><span class="p">,</span> <span class="n">filter_pyx_definition</span><span class="p">,</span> <span class="n">convolve_code</span><span class="p">,</span> <span class="n">sum_code</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        OpenMP code generation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Basic ids</span>
        <span class="n">base_ids</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id_proj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;size_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="c1"># Fill the basic definitions</span>
        <span class="n">conv_dict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">convole_template_omp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">conv_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">%</span> <span class="n">base_ids</span>
            <span class="n">conv_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">conv_dict</span><span class="p">)</span>

        <span class="c1"># Kernel-based method: specify w with the correct dimension</span>
        <span class="k">if</span> <span class="n">kernel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;declare_parameters_variables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tabify</span><span class="p">(</span><span class="n">filter_definition</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;export_parameters_variables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;access_parameters_variables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    // Local parameter w</span>
<span class="s2">    </span><span class="si">%(type_w)s</span><span class="s2"> get_w() { return w; }</span>
<span class="s2">    void set_w(</span><span class="si">%(type_w)s</span><span class="s2"> value) { w = value; }</span>
<span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;type_w&#39;</span><span class="p">:</span> <span class="n">filter_definition</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; w;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;export_connectivity&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        # Local variable w</span>
<span class="s2">        </span><span class="si">%(type_w)s</span><span class="s2"> get_w()</span>
<span class="s2">        void set_w(</span><span class="si">%(type_w)s</span><span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;type_w&#39;</span><span class="p">:</span> <span class="n">filter_pyx_definition</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; w&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;wrapper_init_connectivity&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        proj</span><span class="si">%(id_proj)s</span><span class="s2">.set_w(weights)</span>
<span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;id_proj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;wrapper_access_connectivity&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # Local variable w</span>
<span class="s2">    def get_w(self):</span>
<span class="s2">        return proj</span><span class="si">%(id_proj)s</span><span class="s2">.get_w()</span>
<span class="s2">    def set_w(self, value):</span>
<span class="s2">        proj</span><span class="si">%(id_proj)s</span><span class="s2">.set_w( value )</span>
<span class="s2">    def get_dendrite_w(self, int rank):</span>
<span class="s2">        return proj</span><span class="si">%(id_proj)s</span><span class="s2">.get_w()</span>
<span class="s2">    def set_dendrite_w(self, int rank, value):</span>
<span class="s2">        proj</span><span class="si">%(id_proj)s</span><span class="s2">.set_w(value)</span>
<span class="s2">    def get_synapse_w(self, int rank_post, int rank_pre):</span>
<span class="s2">        return 0.0</span>
<span class="s2">    def set_synapse_w(self, int rank_post, int rank_pre, </span><span class="si">%(float_prec)s</span><span class="s2"> value):</span>
<span class="s2">        pass</span>
<span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;id_proj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]}</span>

        <span class="c1"># Override the monitor to avoid recording the weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;monitor_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;monitor_export&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;monitor_wrapper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># OMP code</span>
        <span class="n">omp_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_threads&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">omp_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        #pragma omp for private(sum, rk_pre, coord) </span><span class="si">%(psp_schedule)s</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;psp_schedule&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;psp_schedule&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omp_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omp_config</span><span class="p">[</span><span class="s1">&#39;psp_schedule&#39;</span><span class="p">]}</span>

        <span class="c1"># HD ( 16.10.2015 ):</span>
        <span class="c1"># pre-load delayed firing rate in a local array, so we</span>
        <span class="c1"># prevent multiple accesses to pop%(id_pre)s._delayed_r[delay-1]</span>
        <span class="c1"># wheareas delay is set available as variable</span>
        <span class="c1"># TODO HD: wouldn&#39;t it be much better to reduce delay globaly, instead of the substraction here???</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span> <span class="o">&gt;</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]:</span>
            <span class="n">pre_load_r</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        // pre-load delayed firing rate</span>
<span class="s2">        auto delayed_r = pop</span><span class="si">%(id_pre)s</span><span class="s2">._delayed_r[delay-1];</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">%</span> <span class="p">{</span><span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pre_load_r</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Compute sum</span>
        <span class="n">wsum</span> <span class="o">=</span>  <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        if ( _transmission &amp;&amp; pop</span><span class="si">%(id_pre)s</span><span class="s2">._active ) {</span>
<span class="s2">            int* coord;</span>
<span class="s2">&quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">pre_load_r</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            </span><span class="si">%(omp_code)s</span><span class="s2"></span>
<span class="s2">            for(int i = 0; i &lt; </span><span class="si">%(size_post)s</span><span class="s2">; i++){</span>
<span class="s2">                coord = pre_coords[i].data();</span>

<span class="s2">                // perform the convolution</span>
<span class="s2">&quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">tabify</span><span class="p">(</span><span class="n">convolve_code</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">                // store result</span>
<span class="s2">                pop</span><span class="si">%(id_post)s</span><span class="s2">._sum_</span><span class="si">%(target)s</span><span class="s2">[i] += &quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">sum_code</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;;</span>
<span class="s2">            } // for</span>
<span class="s2">        } // if</span>
<span class="s2">&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;psp_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wsum</span> <span class="o">%</span> \
        <span class="p">{</span>   <span class="s1">&#39;id_proj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
            <span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;name_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;size_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;id_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;name_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;size_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;omp_code&#39;</span><span class="p">:</span> <span class="n">omp_code</span><span class="p">,</span>
            <span class="s1">&#39;convolve_code&#39;</span><span class="p">:</span> <span class="n">convolve_code</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;size_in_bytes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        // post-ranks</span>
<span class="s2">        size_in_bytes += sizeof(std::vector&lt;int&gt;);</span>
<span class="s2">        size_in_bytes += post_rank.capacity() * sizeof(int);</span>

<span class="s2">        // pre-coords</span>
<span class="s2">        size_in_bytes += sizeof(std::vector&lt;std::vector&lt;int&gt;&gt;);</span>
<span class="s2">        size_in_bytes += pre_coords.capacity() * sizeof(std::vector&lt;int&gt;);</span>
<span class="s2">        for (auto it = pre_coords.begin(); it != pre_coords.end(); it++) {</span>
<span class="s2">            size_in_bytes += it-&gt;capacity() * sizeof(int);</span>
<span class="s2">        }</span>

<span class="s2">        // filter</span>
<span class="s2">        // TODO:</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;clear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        // post-ranks</span>
<span class="s2">        post_rank.clear();</span>
<span class="s2">        post_rank.shrink_to_fit();</span>

<span class="s2">        // pre-coords</span>
<span class="s2">        for (auto it = pre_coords.begin(); it != pre_coords.end(); it++) {</span>
<span class="s2">            it-&gt;clear();</span>
<span class="s2">            it-&gt;shrink_to_fit();</span>
<span class="s2">        }</span>
<span class="s2">        pre_coords.clear();</span>
<span class="s2">        pre_coords.shrink_to_fit();</span>

<span class="s2">        // filter</span>
<span class="s2">        // TODO:</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="c1">################################</span>
    <span class="c1">### Utilities</span>
    <span class="c1">################################</span>
    <span class="k">def</span> <span class="nf">_center_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_filter_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span>
        <span class="n">cpp</span> <span class="o">=</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span>
        <span class="n">pyx</span> <span class="o">=</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
            <span class="n">cpp</span> <span class="o">=</span> <span class="s1">&#39;std::vector&lt; &#39;</span> <span class="o">+</span> <span class="n">cpp</span> <span class="o">+</span> <span class="s1">&#39; &gt;&#39;</span>
            <span class="n">pyx</span> <span class="o">=</span> <span class="s1">&#39;vector[&#39;</span> <span class="o">+</span> <span class="n">pyx</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>
        <span class="n">cpp</span> <span class="o">+=</span> <span class="s1">&#39; w;&#39;</span>
        <span class="n">pyx</span> <span class="o">+=</span> <span class="s1">&#39; w&#39;</span>
        <span class="k">return</span> <span class="n">cpp</span><span class="p">,</span> <span class="n">pyx</span>

    <span class="k">def</span> <span class="nf">_coordinates_to_rank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">geometry</span><span class="p">):</span>

        <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">geometry</span><span class="p">)</span>

        <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">txt</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="p">:</span> <span class="c1"># first coordinate is special</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="n">d</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;*(&#39;</span> <span class="o">+</span> <span class="n">txt</span> <span class="o">+</span> <span class="s1">&#39;) + &#39;</span> <span class="o">+</span> <span class="n">indices</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>  <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name</span>

        <span class="k">return</span> <span class="n">txt</span>

    <span class="k">def</span> <span class="nf">_generate_convolve_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Operation to be performed: sum, max, min, mean</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">operation</span>

        <span class="c1"># Main code</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;sum = 0.0;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Generate for loops</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">inner_idx</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">inner_idx</span> <span class="o">+=</span> <span class="s2">&quot;[&quot;</span><span class="o">+</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_w]&quot;</span>
                <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;auto inner_line = w&quot;</span><span class="o">+</span><span class="n">inner_idx</span><span class="o">+</span><span class="s2">&quot;.data();</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            for(int </span><span class="si">%(index)s</span><span class="s2">_w = 0; </span><span class="si">%(index)s</span><span class="s2">_w &lt; </span><span class="si">%(size)s</span><span class="s2">;</span><span class="si">%(index)s</span><span class="s2">_w++) {</span>
<span class="s2">            &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]},</span> <span class="n">dim</span><span class="p">)</span>

            <span class="c1"># Compute indices</span>
            <span class="k">if</span> <span class="n">dim</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;int %(index)s_pre = coord[%(dim)s] %(operator)s (%(index)s_w - %(center)s);&quot;&quot;&quot;</span> <span class="o">%</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;id_proj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                            <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span>
                            <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="n">dim</span><span class="p">,</span>
                            <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="s1">&#39;+&#39;</span> <span class="p">,</span>
                            <span class="s1">&#39;center&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span>
                        <span class="p">},</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;int %(index)s_pre = coord[%(dim)s];&quot;&quot;&quot;</span> <span class="o">%</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;id_proj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                            <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span>
                            <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="n">dim</span>
                        <span class="p">},</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Check indices</span>
            <span class="k">if</span> <span class="n">operation</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="c1"># &#39;border&#39;</span>
                        <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                if (</span><span class="si">%(index)s</span><span class="s2">_pre &lt; 0) </span><span class="si">%(index)s</span><span class="s2">_pre = 0 ;</span>
<span class="s2">                if (</span><span class="si">%(index)s</span><span class="s2">_pre &gt; </span><span class="si">%(max_size)s</span><span class="s2">) </span><span class="si">%(index)s</span><span class="s2">_pre = </span><span class="si">%(max_size)s</span><span class="s2"> ;</span>
<span class="s2">                &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="n">dim</span><span class="p">,</span> <span class="s1">&#39;max_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="n">dim</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                if ((</span><span class="si">%(index)s</span><span class="s2">_pre &lt; 0) || (</span><span class="si">%(index)s</span><span class="s2">_pre &gt; </span><span class="si">%(max_size)s</span><span class="s2">)){</span>
<span class="s2">                    sum += </span><span class="si">%(padding)s</span><span class="s2">;</span>
<span class="s2">                    continue;</span>
<span class="s2">                }</span>
<span class="s2">                &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="s1">&#39;padding&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span> <span class="s1">&#39;max_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="n">dim</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span> <span class="c1"># min, max</span>
                <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                if ((</span><span class="si">%(index)s</span><span class="s2">_pre &lt; 0) || (</span><span class="si">%(index)s</span><span class="s2">_pre &gt; </span><span class="si">%(max_size)s</span><span class="s2">)) {</span>
<span class="s2">                    continue;</span>
<span class="s2">                }</span>
<span class="s2">                &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="s1">&#39;max_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>

        <span class="c1"># if True, we need to take the last dimension from coords</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_last_dimension</span><span class="p">:</span>
            <span class="n">id_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">],</span>
                <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span>
            <span class="p">}</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;int </span><span class="si">%(index)s</span><span class="s2">_pre = coord[</span><span class="si">%(dim)s</span><span class="s2">];&quot;</span> <span class="o">%</span> <span class="n">id_dict</span>

        <span class="c1"># Compute pre-synaptic rank</span>
        <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                rk_pre = </span><span class="si">%(value)s</span><span class="s2">;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates_to_rank</span><span class="p">(</span><span class="s1">&#39;pre&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">)},</span> <span class="n">dim</span><span class="p">)</span>

        <span class="c1"># Compute the increment</span>
        <span class="n">index</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_w]&#39;</span>

        <span class="n">increment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">description</span><span class="p">[</span><span class="s1">&#39;psp&#39;</span><span class="p">][</span><span class="s1">&#39;cpp&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;id_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;local_index&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span>
            <span class="s1">&#39;global_index&#39;</span><span class="p">:</span> <span class="s1">&#39;[i]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pre_index&#39;</span><span class="p">:</span> <span class="s1">&#39;[rk_pre]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;post_index&#39;</span><span class="p">:</span> <span class="s1">&#39;[rk_post]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pre_prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;pop&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;post_prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;pop&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span>
        <span class="p">}</span>

        <span class="c1"># Delays</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span> <span class="o">&gt;</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]:</span>
            <span class="n">increment</span> <span class="o">=</span> <span class="n">increment</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s1">&#39;pop</span><span class="si">%(id_pre)s</span><span class="s1">.r[rk_pre]&#39;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">},</span>
                <span class="s1">&#39;delayed_r[rk_pre]&#39;</span>
            <span class="p">)</span>

        <span class="c1"># Apply the operation</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                sum += </span><span class="si">%(increment)s</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;increment&#39;</span><span class="p">:</span> <span class="n">increment</span><span class="p">},</span> <span class="n">dim</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                sum += </span><span class="si">%(increment)s</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;increment&#39;</span><span class="p">:</span> <span class="n">increment</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="o">+</span><span class="n">inner_idx</span><span class="p">,</span> <span class="s1">&#39;inner_line&#39;</span><span class="p">)},</span> <span class="n">dim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                </span><span class="si">%(float_prec)s</span><span class="s2"> _psp = </span><span class="si">%(increment)s</span><span class="s2"></span>
<span class="s2">                if(_psp &gt; sum) sum = _psp;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;increment&#39;</span><span class="p">:</span> <span class="n">increment</span><span class="p">,</span> <span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]},</span> <span class="n">dim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                </span><span class="si">%(float_prec)s</span><span class="s2"> _psp = </span><span class="si">%(increment)s</span><span class="s2"></span>
<span class="s2">                if(_psp &lt; sum) sum = _psp;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;increment&#39;</span><span class="p">:</span> <span class="n">increment</span><span class="p">,</span> <span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]},</span> <span class="n">dim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                sum += </span><span class="si">%(increment)s</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;increment&#39;</span><span class="p">:</span> <span class="n">increment</span><span class="p">},</span> <span class="n">dim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: Operation&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="s1">&#39;is not implemented yet for shared projections.&#39;</span><span class="p">)</span>

        <span class="c1"># Close for loops</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">):</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            }&quot;&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">dim</span><span class="p">)</span>

        <span class="n">impl_code</span> <span class="o">=</span> <span class="n">code</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;id_proj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
            <span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;name_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;size_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;id_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;name_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;size_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span>
          <span class="p">}</span>

        <span class="c1"># sum code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">sum_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;sum/</span><span class="si">%(filter_size)s</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;filter_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">size</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sum_code</span> <span class="o">=</span> <span class="s2">&quot;sum&quot;</span>

        <span class="k">return</span> <span class="n">impl_code</span><span class="p">,</span> <span class="n">sum_code</span>

    <span class="k">def</span> <span class="nf">_generate_bank_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Operation to be performed: sum, max, min, mean</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">operation</span>

        <span class="c1"># Main code</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;sum = 0.0;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Generate for loops</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            for(int </span><span class="si">%(index)s</span><span class="s2">_w = 0; </span><span class="si">%(index)s</span><span class="s2">_w &lt; </span><span class="si">%(size)s</span><span class="s2">;</span><span class="si">%(index)s</span><span class="s2">_w++) {</span>
<span class="s2">            &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">]},</span> <span class="n">dim</span><span class="p">)</span>

            <span class="c1"># Compute indices</span>
            <span class="k">if</span> <span class="n">dim</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;int %(index)s_pre = coord[%(dim)s] %(operator)s (%(index)s_w - %(center)s);&quot;&quot;&quot;</span> <span class="o">%</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;id_proj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span>
                        <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="n">dim</span><span class="p">,</span>
                        <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;center&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">},</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;int %(index)s_pre = coord[%(dim)s];&quot;&quot;&quot;</span> <span class="o">%</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;id_proj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span>
                        <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="n">dim</span>
                    <span class="p">},</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Check indices</span>
            <span class="k">if</span> <span class="n">operation</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="c1"># &#39;border&#39;</span>
                    <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            if (</span><span class="si">%(index)s</span><span class="s2">_pre &lt; 0) </span><span class="si">%(index)s</span><span class="s2">_pre = 0 ;</span>
<span class="s2">            if (</span><span class="si">%(index)s</span><span class="s2">_pre &gt; </span><span class="si">%(max_size)s</span><span class="s2">) </span><span class="si">%(index)s</span><span class="s2">_pre = </span><span class="si">%(max_size)s</span><span class="s2"> ;</span>
<span class="s2">            &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="n">dim</span><span class="p">,</span> <span class="s1">&#39;max_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="mi">1</span><span class="o">+</span><span class="n">dim</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            if ((</span><span class="si">%(index)s</span><span class="s2">_pre &lt; 0) || (</span><span class="si">%(index)s</span><span class="s2">_pre &gt; </span><span class="si">%(max_size)s</span><span class="s2">)) {</span>
<span class="s2">                sum += </span><span class="si">%(padding)s</span><span class="s2">;</span>
<span class="s2">                continue;</span>
<span class="s2">            }</span>
<span class="s2">            &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="s1">&#39;padding&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span> <span class="s1">&#39;max_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="mi">1</span><span class="o">+</span><span class="n">dim</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span> <span class="c1"># min, max</span>
                <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            if ((</span><span class="si">%(index)s</span><span class="s2">_pre &lt; 0) || (</span><span class="si">%(index)s</span><span class="s2">_pre &gt; </span><span class="si">%(max_size)s</span><span class="s2">)){</span>
<span class="s2">                continue;</span>
<span class="s2">            }</span>
<span class="s2">            &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="s1">&#39;max_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="mi">1</span><span class="o">+</span><span class="n">dim</span><span class="p">)</span>

        <span class="c1"># Compute pre-synaptic rank</span>
        <span class="n">code</span> <span class="o">+=</span><span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            rk_pre = </span><span class="si">%(value)s</span><span class="s2">;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates_to_rank</span><span class="p">(</span><span class="s1">&#39;pre&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">)},</span> <span class="mi">1</span><span class="o">+</span><span class="n">dim</span><span class="p">)</span>

        <span class="c1"># Compute the increment</span>
        <span class="n">index</span> <span class="o">=</span> <span class="s2">&quot;[coord[&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;]]&quot;</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_w]&#39;</span>

        <span class="n">increment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">description</span><span class="p">[</span><span class="s1">&#39;psp&#39;</span><span class="p">][</span><span class="s1">&#39;cpp&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;id_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;local_index&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span>
            <span class="s1">&#39;global_index&#39;</span><span class="p">:</span> <span class="s1">&#39;[i]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pre_index&#39;</span><span class="p">:</span> <span class="s1">&#39;[rk_pre]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;post_index&#39;</span><span class="p">:</span> <span class="s1">&#39;[rk_post]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pre_prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;pop&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;post_prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;pop&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">}</span>

        <span class="c1"># Delays</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span> <span class="o">&gt;</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]:</span>
            <span class="n">increment</span> <span class="o">=</span> <span class="n">increment</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s1">&#39;pop</span><span class="si">%(id_pre)s</span><span class="s1">.r[rk_pre]&#39;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">},</span>
                <span class="s1">&#39;delayed_r[rk_pre]&#39;</span>
            <span class="p">)</span>

        <span class="c1"># Apply the operation</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            sum += </span><span class="si">%(increment)s</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;increment&#39;</span><span class="p">:</span> <span class="n">increment</span><span class="p">},</span> <span class="mi">1</span><span class="o">+</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            </span><span class="si">%(float_prec)s</span><span class="s2"> _psp = </span><span class="si">%(increment)s</span><span class="s2"></span>
<span class="s2">            if(_psp &gt; sum) sum = _psp;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;increment&#39;</span><span class="p">:</span> <span class="n">increment</span><span class="p">,</span> <span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]},</span> <span class="mi">1</span><span class="o">+</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            </span><span class="si">%(float_prec)s</span><span class="s2"> _psp = </span><span class="si">%(increment)s</span><span class="s2"></span>
<span class="s2">            if(_psp &lt; sum) sum = _psp;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;increment&#39;</span><span class="p">:</span> <span class="n">increment</span><span class="p">,</span> <span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]},</span> <span class="mi">1</span><span class="o">+</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            sum += </span><span class="si">%(increment)s</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;increment&#39;</span><span class="p">:</span> <span class="n">increment</span><span class="p">},</span> <span class="mi">1</span><span class="o">+</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;SharedProjection: Operation&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="s1">&#39;is not implemented yet for shared projections.&#39;</span><span class="p">)</span>

        <span class="c1"># Close for loops</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="n">tabify</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        }&quot;&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">dim</span><span class="p">)</span>

        <span class="n">impl_code</span> <span class="o">=</span> <span class="n">code</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;id_proj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
            <span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;name_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;size_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;id_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;name_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;size_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span>
        <span class="p">}</span>

        <span class="c1"># sum code</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">sum_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;sum/</span><span class="si">%(filter_size)s</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;filter_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">size</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sum_code</span> <span class="o">=</span> <span class="s2">&quot;sum&quot;</span>

        <span class="k">return</span> <span class="n">impl_code</span><span class="p">,</span> <span class="n">sum_code</span>

    <span class="c1">##############################</span>
    <span class="c1">## Override useless methods</span>
    <span class="c1">##############################</span>
    <span class="k">def</span> <span class="nf">_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Disable saving.&quot;</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;post_ranks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_ranks</span>
        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;attributes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span>
        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span>

        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;dendrites&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;number_of_synapses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">desc</span>

    <span class="k">def</span> <span class="nf">save_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="s2">&quot;Not available.&quot;</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Convolutional projections can not be saved.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="s2">&quot;Not available.&quot;</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Convolutional projections can not be saved.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="s2">&quot;Not available.&quot;</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Convolutional projections can not be loaded.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">receptive_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">in_post_geometry</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="s2">&quot;Not available.&quot;</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Convolutional projections can not display receptive fields.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">connectivity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="s2">&quot;Not available.&quot;</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Convolutional projections can not display connectivity matrices.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h3 id="ANNarchy.extensions.convolution.Convolve.Convolution.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">psp</span><span class="o">=</span><span class="s1">&#39;pre.r * w&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copied</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#ANNarchy.extensions.convolution.Convolve.Convolution.__init__" class="headerlink" title="Permanent link">#</a></h3>

    <div class="doc doc-contents ">

      

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>pre</code></td>
        <td></td>
        <td><p>pre-synaptic population (either its name or a <code>Population</code> object).</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>post</code></td>
        <td></td>
        <td><p>post-synaptic population (either its name or a <code>Population</code> object).</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>target</code></td>
        <td></td>
        <td><p>type of the connection</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>psp</code></td>
        <td></td>
        <td><p>continuous influence of a single synapse on the post-synaptic neuron (default for rate-coded: <code>w*pre.r</code>).</p></td>
        <td><code>&#39;pre.r * w&#39;</code></td>
      </tr>
      <tr>
        <td><code>operation</code></td>
        <td></td>
        <td><p>operation (sum, max, min, mean) performed by the kernel (default: sum).</p></td>
        <td><code>&#39;sum&#39;</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Convolve.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">psp</span><span class="o">=</span><span class="s2">&quot;pre.r * w&quot;</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copied</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param pre: pre-synaptic population (either its name or a ``Population`` object).</span>
<span class="sd">    :param post: post-synaptic population (either its name or a ``Population`` object).</span>
<span class="sd">    :param target: type of the connection</span>
<span class="sd">    :param psp: continuous influence of a single synapse on the post-synaptic neuron (default for rate-coded: ``w*pre.r``).</span>
<span class="sd">    :param operation: operation (sum, max, min, mean) performed by the kernel (default: sum).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create the description, but it will not be used for generation</span>
    <span class="n">Projection</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pre</span><span class="p">,</span>
        <span class="n">post</span><span class="p">,</span>
        <span class="n">target</span><span class="p">,</span>
        <span class="n">synapse</span><span class="o">=</span><span class="n">SharedSynapse</span><span class="p">(</span><span class="n">psp</span><span class="o">=</span><span class="n">psp</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Convolution operation&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Convoluted kernel over the pre-synaptic population.&quot;</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">copied</span><span class="o">=</span><span class="n">copied</span>
    <span class="p">)</span>

    <span class="c1"># Disable saving</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_saveable</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># For copy</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_used_single_filter</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_used_bank_of_filters</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">operation</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ANNarchy.extensions.convolution.Convolve.Convolution.connect_filter" class="doc doc-heading">
<code class="highlight language-python"><span class="n">connect_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">delays</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">keep_last_dimension</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">subsampling</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Convolve.Convolution.connect_filter" class="headerlink" title="Permanent link">#</a></h3>

    <div class="doc doc-contents ">

      <p>Applies a single filter on the pre-synaptic population.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>weights</code></td>
        <td></td>
        <td><p>numpy array or list of lists representing the matrix of weights for the filter.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>delays</code></td>
        <td></td>
        <td><p>delay in synaptic transmission (default: dt). Can only be the same value for all neurons.</p></td>
        <td><code>0.0</code></td>
      </tr>
      <tr>
        <td><code>keep_last_dimension</code></td>
        <td></td>
        <td><p>defines if the last dimension of the pre- and post-synaptic will be convolved in parallel. The weights matrix must have one dimension less than the pre-synaptic population, and the number of neurons in the last dimension of the pre- and post-synaptic populations must match. Default: False.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>padding</code></td>
        <td></td>
        <td><p>value to be used for the rates outside the pre-synaptic population. If it is a floating value, the pre-synaptic population is virtually extended with this value above its boundaries. If it is equal to 'border', the values on the boundaries are repeated. Default: 0.0.</p></td>
        <td><code>0.0</code></td>
      </tr>
      <tr>
        <td><code>subsampling</code></td>
        <td></td>
        <td><p>list for each post-synaptic neuron of coordinates in the pre-synaptic population defining the center of the kernel/filter. Default: None.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Convolve.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">connect_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">delays</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">keep_last_dimension</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">subsampling</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies a single filter on the pre-synaptic population.</span>

<span class="sd">    :param weights: numpy array or list of lists representing the matrix of weights for the filter.</span>
<span class="sd">    :param delays: delay in synaptic transmission (default: dt). Can only be the same value for all neurons.</span>
<span class="sd">    :param keep_last_dimension: defines if the last dimension of the pre- and post-synaptic will be convolved in parallel. The weights matrix must have one dimension less than the pre-synaptic population, and the number of neurons in the last dimension of the pre- and post-synaptic populations must match. Default: False.</span>
<span class="sd">    :param padding: value to be used for the rates outside the pre-synaptic population. If it is a floating value, the pre-synaptic population is virtually extended with this value above its boundaries. If it is equal to &#39;border&#39;, the values on the boundaries are repeated. Default: 0.0.</span>
<span class="sd">    :param subsampling: list for each post-synaptic neuron of coordinates in the pre-synaptic population defining the center of the kernel/filter. Default: None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Process the weights</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

    <span class="c1"># Process the delays</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">delays</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">delays</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">delays</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolutions can only have constant delays.&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">subsampling</span> <span class="o">=</span> <span class="n">subsampling</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">keep_last_dimension</span> <span class="o">=</span> <span class="n">keep_last_dimension</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">padding</span> <span class="o">=</span> <span class="n">padding</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Check dimensions of populations and weight matrix</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">ndim</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">dimension</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: Too many dimensions for the post-synaptic population (maximum 4).&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: Too many dimensions for the pre-synaptic population (maximum 4).&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">&gt;</span> <span class="mi">5</span>  <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: Too many dimensions for the kernel (maximum 4).&#39;</span><span class="p">)</span>

    <span class="c1"># Check if the last axes match for parallel convolution (e.g. 3-2-3)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_last_dimension</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: If the kernel has less dimensions than the pre-synaptic population, you need to set the flag keep_last_dimension to True.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: If the kernel has fewer dimensions than the two populations (keep_last_dimension=True), these must have the same number of neurons in the last dimension.&#39;</span><span class="p">)</span>

    <span class="c1"># If the last dim of the kernel matches the last dim of the pre-pop, the last pop can have one dimension less.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">:</span> <span class="c1"># OK, but check the last dimension of the kernel has the same size as the post-population</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: If the post-synaptic population has less dimensions than the pre-synaptic one, the last dimension of the filter must be equal to the last of the pre-synaptic population.&#39;</span><span class="p">)</span>

    <span class="c1"># Check if it is a bank of filters</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: If the kernel has more dimensions than the pre-synaptic population, you need to use the connect_filters() method.&#39;</span><span class="p">)</span>


    <span class="c1"># Generate the pre-synaptic coordinates</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_generate_pre_coordinates</span><span class="p">()</span>

    <span class="c1"># Finish building the synapses</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">()</span>

    <span class="c1"># For copy</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_used_single_filter</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ANNarchy.extensions.convolution.Convolve.Convolution.connect_filters" class="doc doc-heading">
<code class="highlight language-python"><span class="n">connect_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">delays</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">keep_last_dimension</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">subsampling</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Convolve.Convolution.connect_filters" class="headerlink" title="Permanent link">#</a></h3>

    <div class="doc doc-contents ">

      <p>Applies a set of different filters on the pre-synaptic population.</p>
<p>The weights matrix must have one dimension more than the pre-synaptic populations, and the number of neurons in the last dimension of the post-synaptic population must be equal to the number of filters.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>weights</code></td>
        <td></td>
        <td><p>numpy array or list of lists representing the matrix of weights for the filter.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>delays</code></td>
        <td></td>
        <td><p>delay in synaptic transmission (default: dt). Can only be the same value for all neurons.</p></td>
        <td><code>0.0</code></td>
      </tr>
      <tr>
        <td><code>keep_last_dimension</code></td>
        <td></td>
        <td><p>defines if the last dimension of the pre- and post-synaptic will be convolved in parallel. The weights matrix must have one dimension less than the pre-synaptic population, and the number of neurons in the last dimension of the pre- and post-synaptic populations must match. Default: False.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>padding</code></td>
        <td></td>
        <td><p>value to be used for the rates outside the pre-synaptic population. If it is a floating value, the pre-synaptic population is virtually extended with this value above its boundaries. If it is equal to 'border', the values on the boundaries are repeated. Default: 0.0.</p></td>
        <td><code>0.0</code></td>
      </tr>
      <tr>
        <td><code>subsampling</code></td>
        <td></td>
        <td><p>list for each post-synaptic neuron of coordinates in the pre-synaptic population defining the center of the kernel/filter. Default: None.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Convolve.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">connect_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">delays</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">keep_last_dimension</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">subsampling</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies a set of different filters on the pre-synaptic population.</span>

<span class="sd">    The weights matrix must have one dimension more than the pre-synaptic populations, and the number of neurons in the last dimension of the post-synaptic population must be equal to the number of filters.</span>


<span class="sd">    :param weights: numpy array or list of lists representing the matrix of weights for the filter.</span>
<span class="sd">    :param delays: delay in synaptic transmission (default: dt). Can only be the same value for all neurons.</span>
<span class="sd">    :param keep_last_dimension: defines if the last dimension of the pre- and post-synaptic will be convolved in parallel. The weights matrix must have one dimension less than the pre-synaptic population, and the number of neurons in the last dimension of the pre- and post-synaptic populations must match. Default: False.</span>
<span class="sd">    :param padding: value to be used for the rates outside the pre-synaptic population. If it is a floating value, the pre-synaptic population is virtually extended with this value above its boundaries. If it is equal to &#39;border&#39;, the values on the boundaries are repeated. Default: 0.0.</span>
<span class="sd">    :param subsampling: list for each post-synaptic neuron of coordinates in the pre-synaptic population defining the center of the kernel/filter. Default: None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Process the weights</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

    <span class="c1"># Process the delays</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">delays</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">delays</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">delays</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolutions can only have constant delays.&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">subsampling</span> <span class="o">=</span> <span class="n">subsampling</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">keep_last_dimension</span> <span class="o">=</span> <span class="n">keep_last_dimension</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">padding</span> <span class="o">=</span> <span class="n">padding</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Check dimensions of populations and weight matrix</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">ndim</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">dimension</span>


    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: Too many dimensions for the post-synaptic population (maximum 4).&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: Too many dimensions for the pre-synaptic population (maximum 4).&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">&gt;</span> <span class="mi">5</span>  <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: Too many dimensions for the kernel (maximum 4).&#39;</span><span class="p">)</span>

    <span class="c1"># Check if the last axes match for parallel convolution (e.g. 3-2-3)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_last_dimension</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: If the kernel has less dimensions than the pre-synaptic population, you need to set the flag keep_last_dimension to True.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: If the kernel has fewer dimensions than the two populations (keep_last_dimension=True), these must have the same number of neurons in the last dimension.&#39;</span><span class="p">)</span>

    <span class="c1"># If the last dim of the kernel matches the last dim of the pre-pop, the last pop can have one dimension less.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">:</span> <span class="c1"># OK, but check the last dimension of the kernel has the same size as the post-population</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: If the post-synaptic population has less dimensions than the pre-synaptic one, the last dimension of the filter must be equal to the last of the pre-synaptic population.&#39;</span><span class="p">)</span>

    <span class="c1"># The last dimension of the post population must correspond to the number of filters</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolution:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_kernel</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span><span class="p">)</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Convolution: For multiple filters, the last dimension of the post-synaptic population must have as many neurons as there are filters.&#39;</span><span class="p">)</span>

    <span class="c1"># Generate the pre-synaptic coordinates</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_generate_pre_coordinates_bank</span><span class="p">()</span>

    <span class="c1"># Finish building the synapses</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">()</span>

    <span class="c1"># For copy</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_used_bank_of_filters</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ANNarchy.extensions.convolution.Convolve.Convolution.connectivity_matrix" class="doc doc-heading">
<code class="highlight language-python"><span class="n">connectivity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Convolve.Convolution.connectivity_matrix" class="headerlink" title="Permanent link">#</a></h3>

    <div class="doc doc-contents ">

      <p>Not available.</p>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Convolve.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">connectivity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="s2">&quot;Not available.&quot;</span>
    <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Convolutional projections can not display connectivity matrices.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ANNarchy.extensions.convolution.Convolve.Convolution.load" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Convolve.Convolution.load" class="headerlink" title="Permanent link">#</a></h3>

    <div class="doc doc-contents ">

      <p>Not available.</p>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Convolve.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="s2">&quot;Not available.&quot;</span>
    <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Convolutional projections can not be loaded.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ANNarchy.extensions.convolution.Convolve.Convolution.receptive_fields" class="doc doc-heading">
<code class="highlight language-python"><span class="n">receptive_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">in_post_geometry</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Convolve.Convolution.receptive_fields" class="headerlink" title="Permanent link">#</a></h3>

    <div class="doc doc-contents ">

      <p>Not available.</p>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Convolve.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">receptive_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">in_post_geometry</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="s2">&quot;Not available.&quot;</span>
    <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Convolutional projections can not display receptive fields.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ANNarchy.extensions.convolution.Convolve.Convolution.save" class="doc doc-heading">
<code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Convolve.Convolution.save" class="headerlink" title="Permanent link">#</a></h3>

    <div class="doc doc-contents ">

      <p>Not available.</p>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Convolve.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="s2">&quot;Not available.&quot;</span>
    <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Convolutional projections can not be saved.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ANNarchy.extensions.convolution.Convolve.Convolution.save_connectivity" class="doc doc-heading">
<code class="highlight language-python"><span class="n">save_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Convolve.Convolution.save_connectivity" class="headerlink" title="Permanent link">#</a></h3>

    <div class="doc doc-contents ">

      <p>Not available.</p>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Convolve.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">save_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="s2">&quot;Not available.&quot;</span>
    <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Convolutional projections can not be saved.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="ANNarchy.extensions.convolution.Pooling" class="doc doc-heading">
        <code>ANNarchy.extensions.convolution.Pooling</code>



<a href="#ANNarchy.extensions.convolution.Pooling" class="headerlink" title="Permanent link">#</a></h2>

    <div class="doc doc-contents first">




  <div class="doc doc-children">








  <div class="doc doc-object doc-class">



<h3 id="ANNarchy.extensions.convolution.Pooling.Pooling" class="doc doc-heading">
        <code>
Pooling            (<a title="ANNarchy.core.Projection.Projection" href="../Projection/#ANNarchy.core.Projection.Projection">Projection</a>)
        </code>



<a href="#ANNarchy.extensions.convolution.Pooling.Pooling" class="headerlink" title="Permanent link">#</a></h3>

    <div class="doc doc-contents ">

      <p>Performs a pooling operation (e.g. max.pooling) on the pre-synaptic population.</p>
<p>Each post-synaptic neuron covers a specific region (<code>extent</code>) of the pre-synaptic
population, over which the result of the operation on firing rates will be
assigned to sum(target).</p>
<p>The extent is automatically computed using the geometry of the populations, but can be specified in the `connect_pooling()`` methods.</p>
<p>Example:</p>
<div class="highlight"><pre><span></span><code><span class="n">inp</span> <span class="o">=</span> <span class="n">Population</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">neuron</span><span class="o">=</span><span class="n">Neuron</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="s2">&quot;r = 0.0&quot;</span><span class="p">))</span>
<span class="n">pop</span> <span class="o">=</span> <span class="n">Population</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">neuron</span><span class="o">=</span><span class="n">Neuron</span><span class="p">(</span><span class="n">equations</span><span class="o">=</span><span class="s2">&quot;r = sum(exc)&quot;</span><span class="p">))</span>
<span class="n">proj</span> <span class="o">=</span> <span class="n">Pooling</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">pop</span><span class="p">,</span> <span class="s1">&#39;exc&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">)</span> <span class="c1"># max-pooling</span>
<span class="n">proj</span><span class="o">.</span><span class="n">connect_pooling</span><span class="p">()</span> <span class="c1"># extent=(2, 2) is implicit</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Pooling.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Pooling</span><span class="p">(</span><span class="n">Projection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs a pooling operation (e.g. max.pooling) on the pre-synaptic population.</span>

<span class="sd">    Each post-synaptic neuron covers a specific region (``extent``) of the pre-synaptic</span>
<span class="sd">    population, over which the result of the operation on firing rates will be</span>
<span class="sd">    assigned to sum(target).</span>

<span class="sd">    The extent is automatically computed using the geometry of the populations, but can be specified in the `connect_pooling()`` methods.</span>

<span class="sd">    Example:</span>

<span class="sd">    ```python</span>
<span class="sd">    inp = Population(geometry=(100, 100), neuron=Neuron(parameters=&quot;r = 0.0&quot;))</span>
<span class="sd">    pop = Population(geometry=(50, 50), neuron=Neuron(equations=&quot;r = sum(exc)&quot;))</span>
<span class="sd">    proj = Pooling(inp, pop, &#39;exc&#39;, operation=&#39;max&#39;) # max-pooling</span>
<span class="sd">    proj.connect_pooling() # extent=(2, 2) is implicit</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copied</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param pre: pre-synaptic population (either its name or a ``Population`` object).</span>
<span class="sd">        :param post: post-synaptic population (either its name or a ``Population`` object).</span>
<span class="sd">        :param target: type of the connection</span>
<span class="sd">        :param operation: pooling function to be applied (&quot;max&quot;, &quot;min&quot;, &quot;mean&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">operation</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">]:</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s2">&quot;Pooling: the operation must be either &#39;max&#39;, &#39;mean&#39; or &#39;min&#39;.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">operation</span>

        <span class="n">Projection</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">pre</span><span class="p">,</span>
            <span class="n">post</span><span class="p">,</span>
            <span class="n">target</span><span class="p">,</span>
            <span class="n">synapse</span><span class="o">=</span><span class="n">SharedSynapse</span><span class="p">(</span><span class="n">psp</span><span class="o">=</span><span class="s2">&quot;pre.r&quot;</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Pooling operation&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">operation</span><span class="o">+</span><span class="s2">&quot;-pooling operation over the pre-synaptic population.&quot;</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">copied</span><span class="o">=</span><span class="n">copied</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pre</span><span class="o">.</span><span class="n">neuron_type</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;rate&#39;</span><span class="p">:</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Pooling: only implemented for rate-coded populations.&#39;</span><span class="p">)</span>

        <span class="c1"># check dimensions of populations, should not exceed 4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">dimension</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Pooling: Too many dimensions for the post-synaptic population (maximum 4).&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Pooling: Too many dimensions for the pre-synaptic population (maximum 4).&#39;</span><span class="p">)</span>

        <span class="c1"># Disable saving</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saveable</span> <span class="o">=</span> <span class="kc">False</span>



    <span class="k">def</span> <span class="nf">connect_pooling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delays</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param extent: extent of the pooling area expressed in the geometry of the pre-synaptic population (e.g ``(2, 2)``). In each dimension, the product of this extent with the number of neurons in the post-synaptic population must be equal to the number of pre-synaptic neurons. Default: None.</span>
<span class="sd">        :param delays: synaptic delay in ms</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># process extent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extent_init</span> <span class="o">=</span> <span class="n">extent</span>
        <span class="k">if</span> <span class="n">extent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># compute the extent automatically</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">dimension</span><span class="p">:</span>
                <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span>
                    <span class="s1">&#39;Pooling: If you do not provide the extent parameter, the two populations must have the same number of dimensions.&#39;</span><span class="p">)</span>

            <span class="n">extent</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span><span class="p">):</span>
                <span class="n">extent</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">!=</span> <span class="n">extent</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">]:</span>
                    <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span>
                        <span class="s1">&#39;Pooling: Unable to compute the extent of the pooling area: the number of neurons do not match.&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Pooling: You must provide a tuple for the extent of the pooling operation.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extent</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span><span class="p">:</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Pooling: You must provide a tuple for the extent of the pooling operation.&#39;</span><span class="p">)</span>

        <span class="c1"># process delays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delays</span> <span class="o">=</span> <span class="n">delays</span>

        <span class="c1"># Generate the pre-synaptic coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_extent_coordinates</span><span class="p">()</span>

        <span class="c1"># create fake LIL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">):</span>
        <span class="s2">&quot;Returns a copy of the projection when creating networks.  Internal use only.&quot;</span>
        <span class="n">copied_proj</span> <span class="o">=</span> <span class="n">Pooling</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="n">post</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">copied</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">copied_proj</span><span class="o">.</span><span class="n">extent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span>
        <span class="n">copied_proj</span><span class="o">.</span><span class="n">delays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span>

        <span class="n">copied_proj</span><span class="o">.</span><span class="n">_generate_extent_coordinates</span><span class="p">()</span>
        <span class="n">copied_proj</span><span class="o">.</span><span class="n">_create</span><span class="p">()</span>

        <span class="n">copied_proj</span><span class="o">.</span><span class="n">_connection_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_method</span>
        <span class="n">copied_proj</span><span class="o">.</span><span class="n">_connection_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_args</span>
        <span class="n">copied_proj</span><span class="o">.</span><span class="n">_connection_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_delay</span>
        <span class="n">copied_proj</span><span class="o">.</span><span class="n">_storage_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage_format</span>
        <span class="k">return</span> <span class="n">copied_proj</span>

    <span class="k">def</span> <span class="nf">_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create fake LIL object, just for compilation process</span>

<span class="sd">        :return: no return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">ANNarchy.core.cython_ext.Connector</span> <span class="kn">import</span> <span class="n">LILConnectivity</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;ANNarchy was not successfully installed.&#39;</span><span class="p">)</span>

        <span class="n">lil</span> <span class="o">=</span> <span class="n">LILConnectivity</span><span class="p">()</span>
        <span class="n">lil</span><span class="o">.</span><span class="n">max_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span>
        <span class="n">lil</span><span class="o">.</span><span class="n">uniform_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connector_name</span> <span class="o">=</span> <span class="s2">&quot;Pooling&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connector_description</span> <span class="o">=</span> <span class="s2">&quot;Pooling&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_from_lil</span><span class="p">,</span> <span class="p">(</span><span class="n">lil</span><span class="p">,</span> <span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds up dendrites either from list or dictionary. Called by instantiate().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_method</span><span class="p">:</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span>
                <span class="s1">&#39;Pooling: The projection between &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; and &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; is declared but not connected.&#39;</span><span class="p">)</span>

        <span class="c1"># Create the Cython instance</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;proj&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_wrapper&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cyInstance</span> <span class="o">=</span> <span class="n">proj</span><span class="p">([],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_coordinates</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_extent_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates for each post-neuron the position of the top-left corner, where the pooling should be applied.</span>

<span class="sd">        :return:  a list for each post neuron of the corresponding top-left coordinates</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generates coordinates TODO: Find a more robust way!</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">rk</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">coords</span><span class="p">[</span><span class="n">rk</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">rk</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">rk</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">coords</span><span class="p">[</span><span class="n">rk</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="n">rk</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># over the whole second axis</span>
                    <span class="n">coords</span><span class="p">[</span><span class="n">rk</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="n">rk</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">rk</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                            <span class="n">coords</span><span class="p">[</span><span class="n">rk</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                            <span class="n">rk</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># over the whole third axis</span>
                        <span class="n">coords</span><span class="p">[</span><span class="n">rk</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="n">rk</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># TODO: post has less than 4 dimensions</span>
            <span class="n">rk</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                            <span class="n">coords</span><span class="p">[</span><span class="n">rk</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">l</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
                            <span class="n">rk</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Save the result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_coordinates</span> <span class="o">=</span> <span class="n">coords</span>

    <span class="k">def</span> <span class="nf">_generate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overrides the default code generation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convolve_code</span>
        <span class="n">convolve_code</span><span class="p">,</span> <span class="n">sum_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_pooling_code</span><span class="p">()</span>

        <span class="c1"># Generate the code</span>
        <span class="k">if</span> <span class="n">Global</span><span class="o">.</span><span class="n">_check_paradigm</span><span class="p">(</span><span class="s2">&quot;openmp&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_omp</span><span class="p">(</span><span class="n">convolve_code</span><span class="p">,</span> <span class="n">sum_code</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">Global</span><span class="o">.</span><span class="n">_check_paradigm</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_cuda</span><span class="p">(</span><span class="n">convolve_code</span><span class="p">,</span> <span class="n">sum_code</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s2">&quot;Pooling: not implemented for the configured paradigm&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_pooling_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate loop statements for the desired pooling operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Operation to be performed: sum, max, min, mean</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">operation</span>

        <span class="c1"># Main code</span>
        <span class="c1"># default value for sum in code depends on operation</span>
        <span class="n">sum_default</span> <span class="o">=</span> <span class="s2">&quot;0.0&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
            <span class="n">sum_default</span> <span class="o">=</span> <span class="s2">&quot;std::numeric_limits&lt;</span><span class="si">%(float_prec)s</span><span class="s2">&gt;::max()&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]}</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
            <span class="n">sum_default</span> <span class="o">=</span> <span class="s2">&quot;std::numeric_limits&lt;</span><span class="si">%(float_prec)s</span><span class="s2">&gt;::min()&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]}</span>

        <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            sum = </span><span class="si">%(sum_default)s</span><span class="s2">;</span>
<span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;sum_default&#39;</span><span class="p">:</span> <span class="n">sum_default</span><span class="p">}</span>

        <span class="c1"># Generate for loops</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">):</span>
            <span class="n">ind_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span>
                <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            for(int </span><span class="si">%(index)s</span><span class="s2">_w = 0; </span><span class="si">%(index)s</span><span class="s2">_w &lt; </span><span class="si">%(size)s</span><span class="s2">; </span><span class="si">%(index)s</span><span class="s2">_w++){</span>
<span class="s2">    &quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">ind_dict</span>

        <span class="c1"># Compute indices</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">):</span>
            <span class="n">ind_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span>
                <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="n">dim</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                int </span><span class="si">%(index)s</span><span class="s2">_pre = coord[</span><span class="si">%(dim)s</span><span class="s2">] + </span><span class="si">%(index)s</span><span class="s2">_w;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">ind_dict</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                int </span><span class="si">%(index)s</span><span class="s2">_pre = coord[</span><span class="si">%(dim)s</span><span class="s2">];&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">ind_dict</span>

        <span class="c1"># Check indices</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">):</span>
            <span class="n">ind_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span>
                <span class="s1">&#39;max_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">}</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                if ((</span><span class="si">%(index)s</span><span class="s2">_pre &lt; 0) ||(</span><span class="si">%(index)s</span><span class="s2">_pre &gt; </span><span class="si">%(max_size)s</span><span class="s2">)){</span>
<span class="s2">                    continue;</span>
<span class="s2">                }&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">ind_dict</span>

        <span class="c1"># Compute pre-synaptic rank</span>
        <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                rk_pre = </span><span class="si">%(value)s</span><span class="s2">;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates_to_rank</span><span class="p">(</span><span class="s1">&#39;pre&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">)}</span>

        <span class="c1"># Compute the value to pool</span>
        <span class="n">psp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">description</span><span class="p">[</span><span class="s1">&#39;psp&#39;</span><span class="p">][</span><span class="s1">&#39;cpp&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;id_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;local_index&#39;</span><span class="p">:</span> <span class="s1">&#39;[i][j]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;global_index&#39;</span><span class="p">:</span> <span class="s1">&#39;[i]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pre_index&#39;</span><span class="p">:</span> <span class="s1">&#39;[rk_pre]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;post_index&#39;</span><span class="p">:</span> <span class="s1">&#39;[rk_post]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pre_prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;pop&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;post_prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;pop&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span>
        <span class="p">}</span>

        <span class="c1"># Delays</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span> <span class="o">&gt;</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]:</span>
            <span class="n">psp</span> <span class="o">=</span> <span class="n">psp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s1">&#39;pop</span><span class="si">%(id_pre)s</span><span class="s1">.r[rk_pre]&#39;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">},</span>
                <span class="s1">&#39;pop</span><span class="si">%(id_pre)s</span><span class="s1">._delayed_r[</span><span class="si">%(delay)s</span><span class="s1">][rk_pre]&#39;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;delay&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delays</span><span class="o">/</span><span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)}</span>
            <span class="p">)</span>

        <span class="c1"># Apply the operation</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                </span><span class="si">%(float_prec)s</span><span class="s2"> _psp = </span><span class="si">%(psp)s</span><span class="s2">;</span>
<span class="s2">                if(_psp &gt; sum) sum = _psp;&quot;&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                </span><span class="si">%(float_prec)s</span><span class="s2"> _psp = </span><span class="si">%(psp)s</span><span class="s2">;</span>
<span class="s2">                if(_psp &lt; sum) sum = _psp;&quot;&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                sum += </span><span class="si">%(psp)s</span><span class="s2">;&quot;&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                sum += </span><span class="si">%(psp)s</span><span class="s2">;&quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;SharedProjection: Operation&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="s1">&#39;is not implemented yet for shared projections with pooling.&#39;</span><span class="p">)</span>

        <span class="c1"># Close for loops</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            }&quot;&quot;&quot;</span>

        <span class="n">impl_code</span> <span class="o">=</span> <span class="n">code</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s1">&#39;id_proj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
            <span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;name_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;size_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;id_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;name_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;size_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;psp&#39;</span><span class="p">:</span> <span class="n">psp</span><span class="p">,</span>
            <span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span><span class="p">):</span>
                <span class="n">size</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
            <span class="n">sum_code</span> <span class="o">=</span> <span class="s2">&quot;sum/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sum_code</span> <span class="o">=</span> <span class="s2">&quot;sum&quot;</span>

        <span class="k">return</span> <span class="n">impl_code</span><span class="p">,</span> <span class="n">sum_code</span>

    <span class="k">def</span> <span class="nf">_generate_omp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">convolve_code</span><span class="p">,</span> <span class="n">sum_code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the ProjectionGenerator._specific_template structure and bypass the standard openMP code generation.</span>

<span class="sd">        :param convolve_code:</span>
<span class="sd">        :param sum_code:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># default value for sum in code depends on operation</span>
        <span class="n">sum_default</span> <span class="o">=</span> <span class="s2">&quot;0.0&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
            <span class="n">sum_default</span> <span class="o">=</span> <span class="s2">&quot;std::numeric_limits&lt;</span><span class="si">%(float_prec)s</span><span class="s2">&gt;::max()&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]}</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
            <span class="n">sum_default</span> <span class="o">=</span> <span class="s2">&quot;std::numeric_limits&lt;</span><span class="si">%(float_prec)s</span><span class="s2">&gt;::min()&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]}</span>

        <span class="c1"># Specific template for generation</span>
        <span class="n">pool_dict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">pooling_template_omp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pool_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">%</span> <span class="p">{</span>
                <span class="s1">&#39;id_proj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;size_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                <span class="s1">&#39;sum_default&#39;</span><span class="p">:</span> <span class="n">sum_default</span><span class="p">,</span>
                <span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="n">pool_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pool_dict</span><span class="p">)</span>

        <span class="c1"># OMP code</span>
        <span class="n">omp_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_threads&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">omp_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        #pragma omp for private(sum, rk_pre, coord) </span><span class="si">%(psp_schedule)s</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span>
                <span class="s1">&#39;psp_schedule&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;psp_schedule&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omp_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omp_config</span><span class="p">[</span>
                    <span class="s1">&#39;psp_schedule&#39;</span><span class="p">]}</span>

        <span class="c1"># HD ( 16.10.2015 ):</span>
        <span class="c1"># pre-load delayed firing rate in a local array, so we</span>
        <span class="c1"># prevent multiple accesses to pop%(id_pre)s._delayed_r[%(delay)s]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span> <span class="o">&gt;</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]:</span>
            <span class="n">pre_load_r</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        // pre-load delayed firing rate</span>
<span class="s2">        auto delayed_r = pop</span><span class="si">%(id_pre)s</span><span class="s2">._delayed_r[</span><span class="si">%(delay)s</span><span class="s2">];</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;delay&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delays</span> <span class="o">/</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pre_load_r</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Compute sum</span>
        <span class="n">wsum</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        if ( _transmission &amp;&amp; pop</span><span class="si">%(id_pre)s</span><span class="s2">._active ) {</span>
<span class="s2">        std::vector&lt;int&gt; coord;</span>
<span class="s2">&quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">pre_load_r</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        </span><span class="si">%(omp_code)s</span><span class="s2"></span>
<span class="s2">        for(int i = 0; i &lt; </span><span class="si">%(size_post)s</span><span class="s2">; i++){</span>
<span class="s2">            coord = pre_rank[i];</span>
<span class="s2">&quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">convolve_code</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            pop</span><span class="si">%(id_post)s</span><span class="s2">._sum_</span><span class="si">%(target)s</span><span class="s2">[i] += &quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">sum_code</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;;</span>
<span class="s2">        } // for</span>
<span class="s2">        } // if</span>
<span class="s2">&quot;&quot;&quot;</span>

        <span class="c1"># Delays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;wrapper_init_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Psp code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;psp_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wsum</span> <span class="o">%</span> \
                                              <span class="p">{</span><span class="s1">&#39;id_proj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                               <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                                               <span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;name_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                               <span class="s1">&#39;size_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                               <span class="s1">&#39;id_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;name_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                               <span class="s1">&#39;size_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                               <span class="s1">&#39;omp_code&#39;</span><span class="p">:</span> <span class="n">omp_code</span><span class="p">,</span>
                                               <span class="s1">&#39;convolve_code&#39;</span><span class="p">:</span> <span class="n">convolve_code</span>
                                               <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;size_in_bytes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        // connectivity</span>
<span class="s2">        size_in_bytes += sizeof(std::vector&lt;int&gt;);</span>
<span class="s2">        size_in_bytes += pre_rank.capacity() * sizeof(int);</span>

<span class="s2">        size_in_bytes += sizeof(std::vector&lt;std::vector&lt;int&gt;&gt;);</span>
<span class="s2">        size_in_bytes += pre_rank.capacity() * sizeof(std::vector&lt;int&gt;);</span>
<span class="s2">        for (auto it = pre_rank.begin(); it != pre_rank.end(); it++) {</span>
<span class="s2">            size_in_bytes += it-&gt;capacity() * sizeof(int);</span>
<span class="s2">        }</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;clear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        // post-ranks</span>
<span class="s2">        post_rank.clear();</span>
<span class="s2">        post_rank.shrink_to_fit();</span>

<span class="s2">        // pre-ranks sub-lists</span>
<span class="s2">        for (auto it = pre_rank.begin(); it != pre_rank.end(); it++) {</span>
<span class="s2">            it-&gt;clear();</span>
<span class="s2">            it-&gt;shrink_to_fit();</span>
<span class="s2">        }</span>
<span class="s2">        // pre-ranks top-list</span>
<span class="s2">        pre_rank.clear();</span>
<span class="s2">        pre_rank.shrink_to_fit();</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_generate_cuda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">convolve_code</span><span class="p">,</span> <span class="n">sum_code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the ProjectionGenerator._specific_template structure and bypass the standard CUDA code generation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pool_operation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">operation</span>

        <span class="c1"># default value for sum in code depends on operation</span>
        <span class="n">sum_default</span> <span class="o">=</span> <span class="s2">&quot;0.0&quot;</span>
        <span class="k">if</span> <span class="n">pool_operation</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
            <span class="n">sum_default</span> <span class="o">=</span> <span class="s2">&quot;FLT_MAX&quot;</span>
        <span class="k">elif</span> <span class="n">pool_operation</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
            <span class="n">sum_default</span> <span class="o">=</span> <span class="s2">&quot;FLT_MIN&quot;</span>

        <span class="c1"># operation to perform</span>
        <span class="n">pool_op_code</span> <span class="o">=</span> <span class="n">cuda_op_code</span><span class="p">[</span><span class="n">pool_operation</span><span class="p">]</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]}</span>

        <span class="c1"># result dictionary with code for</span>
        <span class="c1"># body, call and header</span>
        <span class="n">pool_template</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">base_ids</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id_proj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;id_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
            <span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
            <span class="s1">&#39;size_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span> <span class="c1"># TODO: population views?</span>
        <span class="p">}</span>

        <span class="c1"># The correct templates depends on both</span>
        <span class="c1"># kernel-geometry and extent</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># For small extents, we compute multiple coords within one warp. If one extent can fill alone</span>
            <span class="c1"># a half-warp we switch to the other implementation.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>

                <span class="n">pool_op_reduce_code</span> <span class="o">=</span> <span class="n">cuda_pooling_code_2d_small_extent</span><span class="p">[</span><span class="s1">&#39;reduce_code&#39;</span><span class="p">][</span><span class="n">pool_operation</span><span class="p">]</span> <span class="o">%</span> <span class="p">{</span>
                    <span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;row_extent&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="s1">&#39;col_extent&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">}</span>

                <span class="n">pool_dict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">base_ids</span><span class="p">)</span>
                <span class="n">pool_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s1">&#39;sum_default&#39;</span><span class="p">:</span> <span class="n">sum_default</span><span class="p">,</span>
                    <span class="s1">&#39;row_extent&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="s1">&#39;col_extent&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="s1">&#39;row_size&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="s1">&#39;col_size&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="s1">&#39;operation&#39;</span><span class="p">:</span> <span class="n">tabify</span><span class="p">(</span><span class="n">pool_op_code</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                    <span class="s1">&#39;operation_reduce&#39;</span><span class="p">:</span> <span class="n">pool_op_reduce_code</span>
                <span class="p">})</span>

                <span class="n">pool_template</span><span class="p">[</span><span class="s1">&#39;psp_body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda_pooling_code_2d_small_extent</span><span class="p">[</span><span class="s1">&#39;psp_body&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="n">pool_dict</span>
                <span class="n">pool_template</span><span class="p">[</span><span class="s1">&#39;psp_header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda_pooling_code_2d_small_extent</span><span class="p">[</span><span class="s1">&#39;psp_header&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="n">pool_dict</span>
                <span class="n">pool_template</span><span class="p">[</span><span class="s1">&#39;psp_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda_pooling_code_2d_small_extent</span><span class="p">[</span><span class="s1">&#39;psp_call&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="n">pool_dict</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">pool_op_reduce_code</span> <span class="o">=</span> <span class="n">cuda_pooling_code_2d</span><span class="p">[</span><span class="s1">&#39;reduce_code&#39;</span><span class="p">][</span><span class="n">pool_operation</span><span class="p">]</span> <span class="o">%</span> <span class="p">{</span>
                    <span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;row_extent&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="s1">&#39;col_extent&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">}</span>

                <span class="n">pool_dict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">base_ids</span><span class="p">)</span>
                <span class="n">pool_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s1">&#39;sum_default&#39;</span><span class="p">:</span> <span class="n">sum_default</span><span class="p">,</span>
                    <span class="s1">&#39;row_extent&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="s1">&#39;col_extent&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="s1">&#39;row_size&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="s1">&#39;col_size&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="s1">&#39;operation&#39;</span><span class="p">:</span> <span class="n">tabify</span><span class="p">(</span><span class="n">pool_op_code</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                    <span class="s1">&#39;operation_reduce&#39;</span><span class="p">:</span> <span class="n">tabify</span><span class="p">(</span><span class="n">pool_op_reduce_code</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="p">})</span>

                <span class="n">pool_template</span><span class="p">[</span><span class="s1">&#39;psp_body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">remove_trailing_spaces</span><span class="p">(</span><span class="n">cuda_pooling_code_2d</span><span class="p">[</span><span class="s1">&#39;psp_body&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="n">pool_dict</span><span class="p">)</span>
                <span class="n">pool_template</span><span class="p">[</span><span class="s1">&#39;psp_header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda_pooling_code_2d</span><span class="p">[</span><span class="s1">&#39;psp_header&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="n">pool_dict</span>
                <span class="n">pool_template</span><span class="p">[</span><span class="s1">&#39;psp_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda_pooling_code_2d</span><span class="p">[</span><span class="s1">&#39;psp_call&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="n">pool_dict</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>

            <span class="n">pool_dict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">base_ids</span><span class="p">)</span>
            <span class="n">pool_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;sum_default&#39;</span><span class="p">:</span> <span class="n">sum_default</span><span class="p">,</span>
                <span class="s1">&#39;row_extent&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;col_extent&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;plane_extent&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="s1">&#39;row_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;col_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;plane_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="s1">&#39;operation&#39;</span><span class="p">:</span> <span class="n">tabify</span><span class="p">(</span><span class="n">pool_op_code</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="p">})</span>

            <span class="n">pool_template</span><span class="p">[</span><span class="s1">&#39;psp_body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">remove_trailing_spaces</span><span class="p">(</span><span class="n">cuda_pooling_code_3d</span><span class="p">[</span><span class="s1">&#39;psp_body&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="n">pool_dict</span><span class="p">)</span>
            <span class="n">pool_template</span><span class="p">[</span><span class="s1">&#39;psp_header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda_pooling_code_3d</span><span class="p">[</span><span class="s1">&#39;psp_header&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="n">pool_dict</span>
            <span class="n">pool_template</span><span class="p">[</span><span class="s1">&#39;psp_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda_pooling_code_3d</span><span class="p">[</span><span class="s1">&#39;psp_header&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="n">pool_dict</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="c1"># Update psp fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pool_template</span><span class="p">)</span>

        <span class="c1"># Specific template for generation (wrapper, etc)</span>
        <span class="n">pool_dict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">pooling_template_cuda</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pool_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">%</span> <span class="n">base_ids</span>
            <span class="n">pool_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pool_dict</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;wrapper_connector_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;access_parameters_variables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="p">[</span><span class="s1">&#39;size_in_bytes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;//TODO:</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_coordinates_to_rank</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">geometry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the code for array access, for instance used</span>
<span class="sd">        for pre-synaptic ranks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">geometry</span><span class="p">)</span>

        <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">txt</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>   <span class="c1"># first coordinate is special</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="n">d</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;*(&#39;</span> <span class="o">+</span> <span class="n">txt</span> <span class="o">+</span> <span class="s1">&#39;) + &#39;</span> <span class="o">+</span> <span class="n">indices</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name</span>

        <span class="k">return</span> <span class="n">txt</span>

    <span class="c1">##############################</span>
    <span class="c1">## Override useless methods</span>
    <span class="c1">##############################</span>
    <span class="k">def</span> <span class="nf">_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Disable saving.&quot;</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;post_ranks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_ranks</span>
        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;attributes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span>
        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span>

        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;dendrites&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;number_of_synapses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">desc</span>

    <span class="k">def</span> <span class="nf">save_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="s2">&quot;Not available.&quot;</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Pooling projections can not be saved.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="s2">&quot;Not available.&quot;</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Pooling projections can not be saved.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="s2">&quot;Not available.&quot;</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Pooling projections can not be loaded.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">receptive_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">in_post_geometry</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="s2">&quot;Not available.&quot;</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Pooling projections can not display receptive fields.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">connectivity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="s2">&quot;Not available.&quot;</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Pooling projections can not display connectivity matrices.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="ANNarchy.extensions.convolution.Pooling.Pooling.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copied</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#ANNarchy.extensions.convolution.Pooling.Pooling.__init__" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

      

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>pre</code></td>
        <td></td>
        <td><p>pre-synaptic population (either its name or a <code>Population</code> object).</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>post</code></td>
        <td></td>
        <td><p>post-synaptic population (either its name or a <code>Population</code> object).</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>target</code></td>
        <td></td>
        <td><p>type of the connection</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>operation</code></td>
        <td></td>
        <td><p>pooling function to be applied ("max", "min", "mean")</p></td>
        <td><code>&#39;max&#39;</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Pooling.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copied</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param pre: pre-synaptic population (either its name or a ``Population`` object).</span>
<span class="sd">    :param post: post-synaptic population (either its name or a ``Population`` object).</span>
<span class="sd">    :param target: type of the connection</span>
<span class="sd">    :param operation: pooling function to be applied (&quot;max&quot;, &quot;min&quot;, &quot;mean&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">operation</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">]:</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s2">&quot;Pooling: the operation must be either &#39;max&#39;, &#39;mean&#39; or &#39;min&#39;.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">operation</span>

    <span class="n">Projection</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pre</span><span class="p">,</span>
        <span class="n">post</span><span class="p">,</span>
        <span class="n">target</span><span class="p">,</span>
        <span class="n">synapse</span><span class="o">=</span><span class="n">SharedSynapse</span><span class="p">(</span><span class="n">psp</span><span class="o">=</span><span class="s2">&quot;pre.r&quot;</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Pooling operation&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">operation</span><span class="o">+</span><span class="s2">&quot;-pooling operation over the pre-synaptic population.&quot;</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">copied</span><span class="o">=</span><span class="n">copied</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">pre</span><span class="o">.</span><span class="n">neuron_type</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;rate&#39;</span><span class="p">:</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Pooling: only implemented for rate-coded populations.&#39;</span><span class="p">)</span>

    <span class="c1"># check dimensions of populations, should not exceed 4</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">dimension</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_post</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Pooling: Too many dimensions for the post-synaptic population (maximum 4).&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_pre</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Pooling: Too many dimensions for the pre-synaptic population (maximum 4).&#39;</span><span class="p">)</span>

    <span class="c1"># Disable saving</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_saveable</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="ANNarchy.extensions.convolution.Pooling.Pooling.connect_pooling" class="doc doc-heading">
<code class="highlight language-python"><span class="n">connect_pooling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delays</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Pooling.Pooling.connect_pooling" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

      

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>extent</code></td>
        <td></td>
        <td><p>extent of the pooling area expressed in the geometry of the pre-synaptic population (e.g <code>(2, 2)</code>). In each dimension, the product of this extent with the number of neurons in the post-synaptic population must be equal to the number of pre-synaptic neurons. Default: None.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>delays</code></td>
        <td></td>
        <td><p>synaptic delay in ms</p></td>
        <td><code>0.0</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Pooling.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">connect_pooling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delays</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param extent: extent of the pooling area expressed in the geometry of the pre-synaptic population (e.g ``(2, 2)``). In each dimension, the product of this extent with the number of neurons in the post-synaptic population must be equal to the number of pre-synaptic neurons. Default: None.</span>
<span class="sd">    :param delays: synaptic delay in ms</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># process extent</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">extent_init</span> <span class="o">=</span> <span class="n">extent</span>
    <span class="k">if</span> <span class="n">extent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># compute the extent automatically</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">dimension</span><span class="p">:</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span>
                <span class="s1">&#39;Pooling: If you do not provide the extent parameter, the two populations must have the same number of dimensions.&#39;</span><span class="p">)</span>

        <span class="n">extent</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span><span class="p">):</span>
            <span class="n">extent</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">!=</span> <span class="n">extent</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">dim</span><span class="p">]:</span>
                <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span>
                    <span class="s1">&#39;Pooling: Unable to compute the extent of the pooling area: the number of neurons do not match.&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Pooling: You must provide a tuple for the extent of the pooling operation.&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">extent</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dimension</span><span class="p">:</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Pooling: You must provide a tuple for the extent of the pooling operation.&#39;</span><span class="p">)</span>

    <span class="c1"># process delays</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">delays</span> <span class="o">=</span> <span class="n">delays</span>

    <span class="c1"># Generate the pre-synaptic coordinates</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_generate_extent_coordinates</span><span class="p">()</span>

    <span class="c1"># create fake LIL</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">()</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="ANNarchy.extensions.convolution.Pooling.Pooling.connectivity_matrix" class="doc doc-heading">
<code class="highlight language-python"><span class="n">connectivity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Pooling.Pooling.connectivity_matrix" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

      <p>Not available.</p>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Pooling.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">connectivity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="s2">&quot;Not available.&quot;</span>
    <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Pooling projections can not display connectivity matrices.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="ANNarchy.extensions.convolution.Pooling.Pooling.load" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Pooling.Pooling.load" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

      <p>Not available.</p>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Pooling.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="s2">&quot;Not available.&quot;</span>
    <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Pooling projections can not be loaded.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="ANNarchy.extensions.convolution.Pooling.Pooling.receptive_fields" class="doc doc-heading">
<code class="highlight language-python"><span class="n">receptive_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">in_post_geometry</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Pooling.Pooling.receptive_fields" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

      <p>Not available.</p>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Pooling.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">receptive_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">in_post_geometry</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="s2">&quot;Not available.&quot;</span>
    <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Pooling projections can not display receptive fields.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="ANNarchy.extensions.convolution.Pooling.Pooling.save" class="doc doc-heading">
<code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Pooling.Pooling.save" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

      <p>Not available.</p>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Pooling.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="s2">&quot;Not available.&quot;</span>
    <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Pooling projections can not be saved.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="ANNarchy.extensions.convolution.Pooling.Pooling.save_connectivity" class="doc doc-heading">
<code class="highlight language-python"><span class="n">save_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Pooling.Pooling.save_connectivity" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

      <p>Not available.</p>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Pooling.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">save_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="s2">&quot;Not available.&quot;</span>
    <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Pooling projections can not be saved.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="ANNarchy.extensions.convolution.Copy" class="doc doc-heading">
        <code>ANNarchy.extensions.convolution.Copy</code>



<a href="#ANNarchy.extensions.convolution.Copy" class="headerlink" title="Permanent link">#</a></h2>

    <div class="doc doc-contents first">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h3 id="ANNarchy.extensions.convolution.Copy.Copy" class="doc doc-heading">
        <code>
Copy            (<a title="ANNarchy.core.Projection.Projection" href="../Projection/#ANNarchy.core.Projection.Projection">Projection</a>)
        </code>



<a href="#ANNarchy.extensions.convolution.Copy.Copy" class="headerlink" title="Permanent link">#</a></h3>

    <div class="doc doc-contents ">

      <p>Creates a virtual projection reusing the weights and delays of an already-defined projection.</p>
<p>Although the original projection can be learnable, this one can not. Changes in the original weights will be reflected in this projection. The only possible modifications are <code>psp</code> and <code>operation</code>.</p>
<p>The pre- and post-synaptic populations of both projections must have the same geometry.</p>
<p>Example:</p>
<div class="highlight"><pre><span></span><code><span class="n">proj</span> <span class="o">=</span> <span class="n">Projection</span><span class="p">(</span><span class="n">pop1</span><span class="p">,</span> <span class="n">pop2</span><span class="p">,</span> <span class="s2">&quot;exc&quot;</span><span class="p">)</span>
<span class="n">proj</span><span class="o">.</span><span class="n">connect_fixed_probability</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

<span class="n">copy_proj</span> <span class="o">=</span> <span class="n">Copy</span><span class="p">(</span><span class="n">pop1</span><span class="p">,</span> <span class="n">pop3</span><span class="p">,</span> <span class="s2">&quot;exc&quot;</span><span class="p">)</span>
<span class="n">copy_proj</span><span class="o">.</span><span class="n">connect_copy</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Copy.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Copy</span><span class="p">(</span><span class="n">Projection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a virtual projection reusing the weights and delays of an already-defined projection.</span>

<span class="sd">    Although the original projection can be learnable, this one can not. Changes in the original weights will be reflected in this projection. The only possible modifications are ``psp`` and ``operation``.</span>

<span class="sd">    The pre- and post-synaptic populations of both projections must have the same geometry.</span>

<span class="sd">    Example:</span>

<span class="sd">    ```python</span>
<span class="sd">    proj = Projection(pop1, pop2, &quot;exc&quot;)</span>
<span class="sd">    proj.connect_fixed_probability(0.1, 0.5)</span>

<span class="sd">    copy_proj = Copy(pop1, pop3, &quot;exc&quot;)</span>
<span class="sd">    copy_proj.connect_copy(proj)</span>
<span class="sd">    ```</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">psp</span><span class="o">=</span><span class="s2">&quot;pre.r * w&quot;</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copied</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param pre: pre-synaptic population (either its name or a ``Population`` object).</span>
<span class="sd">        :param post: post-synaptic population (either its name or a ``Population`` object).</span>
<span class="sd">        :param target: type of the connection</span>
<span class="sd">        :param psp: continuous influence of a single synapse on the post-synaptic neuron (default for rate-coded: ``w*pre.r``).</span>
<span class="sd">        :param operation: operation (sum, max, min, mean) performed by the kernel (default: sum).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create the description, but it will not be used for generation</span>
        <span class="n">Projection</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">pre</span><span class="o">=</span><span class="n">pre</span><span class="p">,</span>
            <span class="n">post</span><span class="o">=</span><span class="n">post</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="n">synapse</span> <span class="o">=</span> <span class="n">SharedSynapse</span><span class="p">(</span><span class="n">psp</span><span class="o">=</span><span class="n">psp</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">copied</span><span class="o">=</span><span class="n">copied</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">connect_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">projection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param projection: Existing projection to copy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="n">projection</span>

        <span class="c1"># Sanity checks</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">,</span> <span class="n">Projection</span><span class="p">):</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Copy: You must provide an existing projection to copy().&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">,</span> <span class="p">(</span><span class="n">ConvolutionProjection</span><span class="p">,</span> <span class="n">PoolingProjection</span><span class="p">)):</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Copy: You can only copy regular projections, not shared projections.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Copy: When copying a projection, the geometries must be the same.&#39;</span><span class="p">)</span>

        <span class="c1"># Dummy weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_coordinates</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Finish building the synapses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">):</span>
        <span class="s2">&quot;Returns a copy of the projection when creating networks. Internal use only.&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># create fake LIL object, just for compilation.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">ANNarchy.core.cython_ext.Connector</span> <span class="kn">import</span> <span class="n">LILConnectivity</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;ANNarchy was not successfully installed.&#39;</span><span class="p">)</span>

        <span class="n">lil</span> <span class="o">=</span> <span class="n">LILConnectivity</span><span class="p">()</span>
        <span class="n">lil</span><span class="o">.</span><span class="n">max_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span>
        <span class="n">lil</span><span class="o">.</span><span class="n">uniform_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connector_name</span> <span class="o">=</span> <span class="s2">&quot;Copy&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connector_description</span> <span class="o">=</span> <span class="s2">&quot;Copy projection&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_from_lil</span><span class="p">,</span> <span class="p">(</span><span class="n">lil</span><span class="p">,</span> <span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds up dendrites either from list or dictionary. Called by instantiate().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_method</span><span class="p">:</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Copy: The projection between &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; and &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; is declared but not connected.&#39;</span><span class="p">)</span>

        <span class="c1"># Create the Cython instance</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;proj&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_wrapper&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cyInstance</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_coordinates</span><span class="p">)</span>

        <span class="c1"># Define the list of postsynaptic neurons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_ranks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

        <span class="c1"># Set delays after instantiation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cyInstance</span><span class="o">.</span><span class="n">set_delay</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delays</span><span class="o">/</span><span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_generate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overrides default code generation. This function is called during the code generation procedure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Global</span><span class="o">.</span><span class="n">_check_paradigm</span><span class="p">(</span><span class="s2">&quot;openmp&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_omp</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">Global</span><span class="o">.</span><span class="n">_check_paradigm</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_cuda</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">generate_omp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Code generation of CopyProjection object for the openMP paradigm.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the projection specific parameters</span>
        <span class="n">copy_proj_dict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">copy_proj_template</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">copy_proj_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">%</span> <span class="p">{</span>
                <span class="s1">&#39;id_proj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;id_copy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="n">copy_proj_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Update specific template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">copy_proj_dict</span><span class="p">)</span>

        <span class="c1"># OMP code if more then one thread</span>
        <span class="k">if</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_threads&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">omp_code</span> <span class="o">=</span> <span class="s1">&#39;#pragma omp for private(sum)&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">Global</span><span class="o">.</span><span class="n">OMP_MIN_NB_NEURONS</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">omp_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># PSP</span>
        <span class="n">psp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">description</span><span class="p">[</span><span class="s1">&#39;psp&#39;</span><span class="p">][</span><span class="s1">&#39;cpp&#39;</span><span class="p">]</span>  <span class="o">%</span> <span class="p">{</span>
            <span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;id_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;local_index&#39;</span><span class="p">:</span><span class="s1">&#39;[i][j]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;global_index&#39;</span><span class="p">:</span> <span class="s1">&#39;[i]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pre_index&#39;</span><span class="p">:</span> <span class="s1">&#39;[pre_rank[i][j]]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;post_index&#39;</span><span class="p">:</span> <span class="s1">&#39;[post_rank[i]]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pre_prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;pop&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;post_prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;pop&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">}</span>
        <span class="n">psp</span> <span class="o">=</span> <span class="n">psp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;rk_pre&#39;</span><span class="p">,</span> <span class="s1">&#39;pre_rank[i][j]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Take delays into account if any</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span> <span class="o">&gt;</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]:</span>
            <span class="n">psp</span> <span class="o">=</span> <span class="n">psp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s1">&#39;pop</span><span class="si">%(id_pre)s</span><span class="s1">.r[rk_pre]&#39;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">},</span>
                <span class="s1">&#39;pop</span><span class="si">%(id_pre)s</span><span class="s1">._delayed_r[delay-1][rk_pre]&#39;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
                <span class="c1"># TODO HD: wouldn&#39;t it be much better to reduce delay globaly, instead of the substraction here???</span>
            <span class="p">)</span>

        <span class="c1"># Select template for operation to be performed: sum, max, min, mean</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sum_code</span> <span class="o">=</span> <span class="n">copy_sum_template</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">operation</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s2">&quot;CopyProjection: the operation &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="s1">&#39; is not available.&#39;</span><span class="p">)</span>

        <span class="c1"># Finalize code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">[</span><span class="s1">&#39;omp&#39;</span><span class="p">][</span><span class="s1">&#39;body_compute_psp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_code</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s1">&#39;id_proj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
            <span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;name_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;id_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;name_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
            <span class="s1">&#39;omp_code&#39;</span><span class="p">:</span> <span class="n">omp_code</span><span class="p">,</span>
            <span class="s1">&#39;psp&#39;</span><span class="p">:</span> <span class="n">psp</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_generate_cuda</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Code generation of CopyProjection object for the CUDA paradigm.</span>

<span class="sd">        Note: currently not implemented (TODO HD)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1">##############################</span>
    <span class="c1">## Override useless methods</span>
    <span class="c1">##############################</span>
    <span class="k">def</span> <span class="nf">_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Disable saving.&quot;</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;post_ranks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_ranks</span>
        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;attributes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span>
        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span>

        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;dendrites&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;number_of_synapses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">desc</span>

    <span class="k">def</span> <span class="nf">save_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="s2">&quot;Not available.&quot;</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Copied projections can not be saved.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="s2">&quot;Not available.&quot;</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Copied projections can not be saved.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="s2">&quot;Not available.&quot;</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Copied projections can not be loaded.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">receptive_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">in_post_geometry</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="s2">&quot;Not available.&quot;</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Copied projections can not display receptive fields.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">connectivity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="s2">&quot;Not available.&quot;</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Copied projections can not display connectivity matrices.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="ANNarchy.extensions.convolution.Copy.Copy.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">psp</span><span class="o">=</span><span class="s1">&#39;pre.r * w&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copied</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#ANNarchy.extensions.convolution.Copy.Copy.__init__" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

      

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>pre</code></td>
        <td></td>
        <td><p>pre-synaptic population (either its name or a <code>Population</code> object).</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>post</code></td>
        <td></td>
        <td><p>post-synaptic population (either its name or a <code>Population</code> object).</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>target</code></td>
        <td></td>
        <td><p>type of the connection</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>psp</code></td>
        <td></td>
        <td><p>continuous influence of a single synapse on the post-synaptic neuron (default for rate-coded: <code>w*pre.r</code>).</p></td>
        <td><code>&#39;pre.r * w&#39;</code></td>
      </tr>
      <tr>
        <td><code>operation</code></td>
        <td></td>
        <td><p>operation (sum, max, min, mean) performed by the kernel (default: sum).</p></td>
        <td><code>&#39;sum&#39;</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Copy.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">psp</span><span class="o">=</span><span class="s2">&quot;pre.r * w&quot;</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copied</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param pre: pre-synaptic population (either its name or a ``Population`` object).</span>
<span class="sd">    :param post: post-synaptic population (either its name or a ``Population`` object).</span>
<span class="sd">    :param target: type of the connection</span>
<span class="sd">    :param psp: continuous influence of a single synapse on the post-synaptic neuron (default for rate-coded: ``w*pre.r``).</span>
<span class="sd">    :param operation: operation (sum, max, min, mean) performed by the kernel (default: sum).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create the description, but it will not be used for generation</span>
    <span class="n">Projection</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pre</span><span class="o">=</span><span class="n">pre</span><span class="p">,</span>
        <span class="n">post</span><span class="o">=</span><span class="n">post</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
        <span class="n">synapse</span> <span class="o">=</span> <span class="n">SharedSynapse</span><span class="p">(</span><span class="n">psp</span><span class="o">=</span><span class="n">psp</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">copied</span><span class="o">=</span><span class="n">copied</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="ANNarchy.extensions.convolution.Copy.Copy.connect_copy" class="doc doc-heading">
<code class="highlight language-python"><span class="n">connect_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">projection</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Copy.Copy.connect_copy" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

      

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>projection</code></td>
        <td></td>
        <td><p>Existing projection to copy.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Copy.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">connect_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">projection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param projection: Existing projection to copy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="n">projection</span>

    <span class="c1"># Sanity checks</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">,</span> <span class="n">Projection</span><span class="p">):</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Copy: You must provide an existing projection to copy().&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">,</span> <span class="p">(</span><span class="n">ConvolutionProjection</span><span class="p">,</span> <span class="n">PoolingProjection</span><span class="p">)):</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Copy: You can only copy regular projections, not shared projections.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">geometry</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s1">&#39;Copy: When copying a projection, the geometries must be the same.&#39;</span><span class="p">)</span>

    <span class="c1"># Dummy weights</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pre_coordinates</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Finish building the synapses</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">()</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="ANNarchy.extensions.convolution.Copy.Copy.connectivity_matrix" class="doc doc-heading">
<code class="highlight language-python"><span class="n">connectivity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Copy.Copy.connectivity_matrix" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

      <p>Not available.</p>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Copy.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">connectivity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="s2">&quot;Not available.&quot;</span>
    <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Copied projections can not display connectivity matrices.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="ANNarchy.extensions.convolution.Copy.Copy.generate_omp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">generate_omp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Copy.Copy.generate_omp" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

      <p>Code generation of CopyProjection object for the openMP paradigm.</p>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Copy.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">generate_omp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Code generation of CopyProjection object for the openMP paradigm.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set the projection specific parameters</span>
    <span class="n">copy_proj_dict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">copy_proj_template</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">copy_proj_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s1">&#39;id_proj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;id_copy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">copy_proj_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># Update specific template</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_specific_template</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">copy_proj_dict</span><span class="p">)</span>

    <span class="c1"># OMP code if more then one thread</span>
    <span class="k">if</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_threads&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">omp_code</span> <span class="o">=</span> <span class="s1">&#39;#pragma omp for private(sum)&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">Global</span><span class="o">.</span><span class="n">OMP_MIN_NB_NEURONS</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">omp_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># PSP</span>
    <span class="n">psp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">description</span><span class="p">[</span><span class="s1">&#39;psp&#39;</span><span class="p">][</span><span class="s1">&#39;cpp&#39;</span><span class="p">]</span>  <span class="o">%</span> <span class="p">{</span>
        <span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="s1">&#39;id_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="s1">&#39;local_index&#39;</span><span class="p">:</span><span class="s1">&#39;[i][j]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;global_index&#39;</span><span class="p">:</span> <span class="s1">&#39;[i]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pre_index&#39;</span><span class="p">:</span> <span class="s1">&#39;[pre_rank[i][j]]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;post_index&#39;</span><span class="p">:</span> <span class="s1">&#39;[post_rank[i]]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pre_prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;pop&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;post_prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;pop&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">}</span>
    <span class="n">psp</span> <span class="o">=</span> <span class="n">psp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;rk_pre&#39;</span><span class="p">,</span> <span class="s1">&#39;pre_rank[i][j]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># Take delays into account if any</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span> <span class="o">&gt;</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]:</span>
        <span class="n">psp</span> <span class="o">=</span> <span class="n">psp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s1">&#39;pop</span><span class="si">%(id_pre)s</span><span class="s1">.r[rk_pre]&#39;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">},</span>
            <span class="s1">&#39;pop</span><span class="si">%(id_pre)s</span><span class="s1">._delayed_r[delay-1][rk_pre]&#39;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
            <span class="c1"># TODO HD: wouldn&#39;t it be much better to reduce delay globaly, instead of the substraction here???</span>
        <span class="p">)</span>

    <span class="c1"># Select template for operation to be performed: sum, max, min, mean</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sum_code</span> <span class="o">=</span> <span class="n">copy_sum_template</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">operation</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">Global</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="s2">&quot;CopyProjection: the operation &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="s1">&#39; is not available.&#39;</span><span class="p">)</span>

    <span class="c1"># Finalize code</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">[</span><span class="s1">&#39;omp&#39;</span><span class="p">][</span><span class="s1">&#39;body_compute_psp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_code</span> <span class="o">%</span> <span class="p">{</span>
        <span class="s1">&#39;id_proj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
        <span class="s1">&#39;id_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;name_pre&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;id_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;name_post&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="s1">&#39;float_prec&#39;</span><span class="p">:</span> <span class="n">Global</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
        <span class="s1">&#39;omp_code&#39;</span><span class="p">:</span> <span class="n">omp_code</span><span class="p">,</span>
        <span class="s1">&#39;psp&#39;</span><span class="p">:</span> <span class="n">psp</span>
    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="ANNarchy.extensions.convolution.Copy.Copy.load" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Copy.Copy.load" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

      <p>Not available.</p>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Copy.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="s2">&quot;Not available.&quot;</span>
    <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Copied projections can not be loaded.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="ANNarchy.extensions.convolution.Copy.Copy.receptive_fields" class="doc doc-heading">
<code class="highlight language-python"><span class="n">receptive_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">in_post_geometry</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Copy.Copy.receptive_fields" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

      <p>Not available.</p>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Copy.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">receptive_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">in_post_geometry</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="s2">&quot;Not available.&quot;</span>
    <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Copied projections can not display receptive fields.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="ANNarchy.extensions.convolution.Copy.Copy.save" class="doc doc-heading">
<code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Copy.Copy.save" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

      <p>Not available.</p>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Copy.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="s2">&quot;Not available.&quot;</span>
    <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Copied projections can not be saved.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="ANNarchy.extensions.convolution.Copy.Copy.save_connectivity" class="doc doc-heading">
<code class="highlight language-python"><span class="n">save_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></code>


<a href="#ANNarchy.extensions.convolution.Copy.Copy.save_connectivity" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

      <p>Not available.</p>

        <details class="quote">
          <summary>Source code in <code>ANNarchy/extensions/convolution/Copy.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">save_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="s2">&quot;Not available.&quot;</span>
    <span class="n">Global</span><span class="o">.</span><span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Copied projections can not be saved.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../Hybrid/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Hybrid networks" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Hybrid networks
            </div>
          </div>
        </a>
      
      
        
        <a href="../Logging/" class="md-footer__link md-footer__link--next" aria-label="Next: Logging with tensorboard" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Logging with tensorboard
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021 Julien Vitay, Helge lo Dinkelbach, Fred H. Hamker
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["header.autohide"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.361d90f1.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.289a2a4b.min.js"></script>
      
        <script src="../../javascripts/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>